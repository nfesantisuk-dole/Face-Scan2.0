<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç (Face Scan)</title>
  </head>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" referrerpolicy="no-referrer" rel="stylesheet">
<script src="/_sdk/element_sdk.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
    }
    html {
      height: 100%;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    .toast.success {
      background-color: #10b981;
    }
    .toast.error {
      background-color: #ef4444;
    }
    .toast.info {
      background-color: #3b82f6;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .config-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .config-modal-content {
      background: white;
      padding: 32px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      color: white;
    }
    .loading-overlay .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2500;
      animation: fadeIn 0.2s ease-out;
    }
    .confirm-modal-content {
      background: white;
      padding: 32px;
      border-radius: 16px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .camera-container {
      width: 100%;
      aspect-ratio: 4/3;
      background: #000;
      border-radius: 0.5rem;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .camera-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .camera-container canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
  </style>
<style>@view-transition { navigation: auto; }</style>
<script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</link><script>
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof defaultConfig !== "undefined" && defaultConfig.app_title) {
        document.title = defaultConfig.app_title;
      }
    });
    </script></head>
<body><div class="loading-overlay" id="loading-overlay">
<div class="spinner"></div>
<p class="text-xl font-semibold" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI Models...</p>
<p class="text-sm mt-2" id="loading-progress">0%</p>
</div><div class="config-modal" id="config-modal" style="display: none;">
<div class="config-modal-content">
<h2 class="text-2xl font-bold mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script</h2>
<p class="mb-4 text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App</p><input class="w-full px-4 py-2 border rounded-lg mb-4" id="gas-url-input" placeholder="https://script.google.com/a/macros/cmi.nfe.go.th/s/AKfycbyL5RxlIF_JFYPBlKZS6ZRo7CoCa3tXibtN25FNuPUKVaFtCQbtn2XhZJLClbNmqU9HSg/exec" type="text"/> <button class="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700" id="save-url-btn"> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL </button>
<p class="mt-4 text-sm text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: URL ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ "Who has access" ‡πÄ‡∏õ‡πá‡∏ô "Anyone"</p>
</div>
</div><div class="confirm-modal" id="confirm-delete-modal" style="display: none;">
<div class="confirm-modal-content">
<h2 class="text-2xl font-bold mb-4 text-center" style="color: #ef4444;">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h2>
<p class="mb-6 text-center text-gray-700 text-lg" id="confirm-delete-message"></p>
<div class="flex gap-3"><button class="flex-1 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="confirm-delete-cancel"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button class="flex-1 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors" id="confirm-delete-confirm"> ‡∏•‡∏ö </button>
</div>
</div>
</div>
<div class="min-h-full p-6" id="app" style="display: none;">
<div class="max-w-6xl mx-auto">
<div class="flex justify-between items-center mb-8">
<h1 class="text-4xl font-bold" id="app-title">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç (Face Scan)</h1><button class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700" id="change-url-btn"> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL </button>
</div><div class="flex gap-2 mb-6"><button class="flex-1 py-3 px-6 rounded-lg font-semibold transition-colors" id="main-tab-attendance">‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</button> <button class="flex-1 py-3 px-6 rounded-lg font-semibold transition-colors" id="main-tab-register">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button> <button class="flex-1 py-3 px-6 rounded-lg font-semibold transition-colors" id="main-tab-report">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</button> <button class="flex-1 py-3 px-6 rounded-lg font-semibold transition-colors" id="main-tab-list">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button> <button class="flex-1 py-3 px-6 rounded-lg font-semibold transition-colors" id="main-tab-rooms">üè´ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
</div><div class="hidden" id="attendance-section">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</h2><select class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:outline-none text-lg" id="attendance-room-select"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option> </select>
</div>
<div class="hidden" id="attendance-camera-section">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 p-6 rounded-lg shadow-lg">
<h2 class="text-2xl font-semibold mb-4">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h2>
<div class="camera-container mb-4">
<video autoplay="" class="w-full h-full object-cover" id="attendance-camera-video" muted="" playsinline=""></video>
<canvas class="absolute top-0 left-0 w-full h-full pointer-events-none" id="attendance-camera-canvas"></canvas>
</div>
<div class="px-6 py-3 rounded-lg font-bold text-center shadow-lg mb-4" id="attendance-summary" style="background-color: rgba(16, 185, 129, 0.95); color: white;"><span id="attendance-count">‡∏û‡∏ö 0 ‡∏Ñ‡∏ô</span>
</div>
<div class="flex gap-2"><button class="flex-1 py-5 rounded-lg font-semibold transition-colors" id="start-attendance-camera-btn"> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á </button> <button class="py-5 px-6 rounded-lg font-semibold transition-colors hidden" id="switch-attendance-camera-btn"> üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á </button> <button class="flex-1 py-5 rounded-lg font-semibold transition-colors hidden" id="stop-attendance-camera-btn"> ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á </button>
</div>
</div><div class="p-6 rounded-lg shadow-lg">
<h2 class="text-2xl font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö</h2>
<div class="space-y-2 mb-4 max-h-96 overflow-y-auto" id="detected-list">
<p class="text-center py-8 opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</p>
</div><button class="w-full py-5 rounded-lg font-semibold transition-colors" disabled="" id="save-attendance-btn"> <span id="save-attendance-text">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
<div class="loading-spinner mx-auto hidden" id="save-attendance-loading"></div></button>
</div>
</div>
</div>
</div><div class="hidden" id="register-section">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h2><div class="flex gap-2 mb-4"><button class="flex-1 py-5 px-6 rounded-lg font-semibold transition-colors" id="register-tab-upload">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</button> <button class="flex-1 py-5 px-6 rounded-lg font-semibold transition-colors" id="register-tab-camera">‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
</div><div id="register-upload-section">
<form class="space-y-4" id="add-face-form">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div><label class="block text-sm font-medium mb-2" for="person-name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> <input class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none" id="person-name" required="" type="text"/>
</div>
<div><label class="block text-sm font-medium mb-2" for="student-room">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label> <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none" id="student-room" required=""> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option> </select>
</div>
</div>
<div><label class="block text-sm font-medium mb-2" for="face-image">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label> <input accept="image/*" class="w-full px-4 py-2 border rounded-lg" id="face-image" required="" type="file"/>
</div>
<div class="hidden" id="preview-container"><img class="w-full h-48 object-cover rounded-lg" id="image-preview"/>
</div><button class="w-full py-3 rounded-lg font-semibold transition-colors" id="add-button" type="submit"> <span id="add-button-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
<div class="loading-spinner mx-auto hidden" id="add-loading"></div></button>
</form>
</div><div class="hidden space-y-4" id="register-camera-section">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div><label class="block text-sm font-medium mb-2" for="camera-person-name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> <input class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none" id="camera-person-name" type="text"/>
</div>
<div><label class="block text-sm font-medium mb-2" for="camera-student-room">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label> <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none" id="camera-student-room"> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option> </select>
</div>
</div>
<div class="camera-container">
<video autoplay="" class="w-full h-full object-cover" id="register-camera-video" muted="" playsinline=""></video>
<canvas class="absolute top-0 left-0 w-full h-full pointer-events-none" id="register-camera-canvas"></canvas>
</div>
<div class="flex gap-2"><button class="flex-1 py-3 rounded-lg font-semibold transition-colors" id="start-register-camera-btn"> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á </button> <button class="py-3 px-4 rounded-lg font-semibold transition-colors hidden" id="switch-register-camera-btn"> üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á </button> <button class="flex-1 py-3 rounded-lg font-semibold transition-colors hidden" id="capture-register-btn"> üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û </button> <button class="flex-1 py-3 rounded-lg font-semibold transition-colors hidden" id="save-register-btn"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å </button>
</div>
<canvas class="w-full rounded-lg hidden" id="captured-image-canvas" style="aspect-ratio: 4/3; object-fit: cover;"></canvas>
</div>
</div>
</div><div class="hidden" id="report-section">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
<div><label class="block text-sm font-medium mb-2" for="report-room-select">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label> <select class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:outline-none text-lg" id="report-room-select"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option> </select>
</div>
<div><label class="block text-sm font-medium mb-2" for="report-start-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label> <input class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:outline-none" id="report-start-date" type="date"/>
</div>
<div><label class="block text-sm font-medium mb-2" for="report-end-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label> <input class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:outline-none" id="report-end-date" type="date"/>
</div>
</div><button class="w-full py-4 rounded-lg font-bold text-lg transition-colors shadow-lg hover:shadow-xl" id="load-report-btn"> <span id="load-report-text">üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</span>
<div class="loading-spinner mx-auto hidden" id="load-report-loading"></div></button>
</div>
<div class="hidden" id="report-results">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="p-4 rounded-lg text-center" style="background-color: rgba(59, 130, 246, 0.1);">
<p class="text-sm opacity-70">‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</p>
<p class="text-3xl font-bold mt-2" id="total-students">0</p>
</div>
<div class="p-4 rounded-lg text-center" style="background-color: rgba(16, 185, 129, 0.1);">
<p class="text-sm opacity-70">‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
<p class="text-3xl font-bold mt-2" id="attended-students" style="color: #10b981;">0</p>
</div>
<div class="p-4 rounded-lg text-center" style="background-color: rgba(239, 68, 68, 0.1);">
<p class="text-sm opacity-70">‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
<p class="text-3xl font-bold mt-2" id="absent-students" style="color: #ef4444;">0</p>
</div>
</div>
</div>
<div class="p-6 rounded-lg shadow-lg mb-6">
<div class="flex justify-between items-center mb-4">
<h2 class="text-2xl font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</h2>
<div class="flex gap-2"><button class="px-6 py-3 rounded-lg font-bold transition-colors shadow-md hover:shadow-lg" id="export-excel-btn" style="background-color: #10b981; color: white;"> üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel </button> <button class="px-6 py-3 rounded-lg font-bold transition-colors shadow-md hover:shadow-lg" id="delete-attendance-btn" style="background-color: #ef4444; color: white;"> üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
</div>
</div>
<div class="overflow-x-auto">
<table class="w-full border-collapse" id="report-table">
<thead>
<tr style="background-color: rgba(59, 130, 246, 0.1);">
<th class="border px-4 py-3 text-left">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
<th class="border px-4 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
<th class="border px-4 py-3 text-left">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>
<th class="border px-4 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
<th class="border px-4 py-3 text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
<th class="border px-4 py-3 text-center">‡πÄ‡∏ß‡∏•‡∏≤</th>
</tr>
</thead>
<tbody id="report-table-body">
</tbody>
</table>
</div>
</div>
</div>
</div><div class="hidden" id="list-section">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h2><select class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:outline-none text-lg" id="list-room-filter"> <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option> </select>
</div>
<div class="p-6 rounded-lg shadow-lg">
<h2 class="text-2xl font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (<span id="face-count">0</span>)</h2>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="faces-grid">
<p class="col-span-full text-center py-8 opacity-60">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
</div>
</div>
</div><div class="hidden" id="rooms-section">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
<form class="space-y-4" id="add-room-form">
<div><label class="block text-sm font-medium mb-2" for="new-room-name">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label> <input class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none" id="new-room-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤" required="" type="text"/>
</div><button class="w-full py-3 rounded-lg font-semibold transition-colors" id="add-room-button" type="submit"> <span id="add-room-button-text">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</span>
<div class="loading-spinner mx-auto hidden" id="add-room-loading"></div></button>
</form>
</div>
<div class="p-6 rounded-lg shadow-lg">
<h2 class="text-2xl font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (<span id="room-count">0</span>)</h2>
<div class="space-y-2" id="rooms-list">
<p class="text-center py-8 opacity-60">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
</div>
</div>
</div>
</div>
</div>
<script>
    const defaultConfig = {
      background_color: "#f0f9ff",
      card_color: "#ffffff",
      text_color: "#1e293b",
      primary_button_color: "#3b82f6",
      secondary_button_color: "#ef4444",
      app_title: "‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç (Face Scan)",
      register_button_text: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
      attendance_button_text: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°",
      font_family: "Sarabun, sans-serif",
      font_size: 16
    };

    let ROOMS = [];
    let storedFaces = [];
    let registerCameraStream = null;
    let attendanceCameraStream = null;
    let currentMainTab = 'attendance';
    let currentRegisterTab = 'upload';
    let pendingImageData = null;
    let capturedImageData = null;
    let currentRegisterFacingMode = 'user';
    let currentAttendanceFacingMode = 'user';
    let availableCameras = [];
    let GAS_URL = localStorage.getItem('gas_url') || 'https://script.google.com/a/macros/cmi.nfe.go.th/s/AKfycbyL5RxlIF_JFYPBlKZS6ZRo7CoCa3tXibtN25FNuPUKVaFtCQbtn2XhZJLClbNmqU9HSg/exec';
    let modelsLoaded = false;
    let faceDescriptors = [];
    let attendanceDetectionInterval = null;
    let detectedStudents = new Map();
    let selectedAttendanceRoom = '';
    let selectedListRoomFilter = '';
    let pendingDeleteAction = null;
    
    // --- NEW Code for Speech and Throttle ---
    let lastSpokenId = null; 
    let lastSpokenTime = 0;
    const THROTTLE_TIME = 30000; 
    
    function speakText(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); 
            const speech = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            const thaiVoice = voices.find(voice => voice.lang === 'th-TH' || voice.name.includes('Thai'));
            
            if (thaiVoice) {
                speech.voice = thaiVoice;
            } 
            speech.lang = 'th-TH';
            speech.rate = 1.0; 
            speech.pitch = 1.0;
            
            window.speechSynthesis.speak(speech);
        } else {
            console.error("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Speech Synthesis API.");
        }
    }
    // ----------------------------------------


    // Confirm Delete Modal Functions
    function showConfirmDeleteModal(message, onConfirm) {
      document.getElementById('confirm-delete-message').textContent = message;
      document.getElementById('confirm-delete-modal').style.display = 'flex';
      pendingDeleteAction = onConfirm;
    }

    function hideConfirmDeleteModal() {
      document.getElementById('confirm-delete-modal').style.display = 'none';
      pendingDeleteAction = null;
    }

    document.getElementById('confirm-delete-cancel').addEventListener('click', hideConfirmDeleteModal);

    document.getElementById('confirm-delete-confirm').addEventListener('click', async () => {
      if (pendingDeleteAction) {
        hideConfirmDeleteModal();
        await pendingDeleteAction();
      }
    });

    // Check available cameras
    async function checkAvailableCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        availableCameras = devices.filter(device => device.kind === 'videoinput');
        return availableCameras.length > 1;
      } catch (error) {
        console.error('Error checking cameras:', error);
        return false;
      }
    }

    // Load Face-API.js Models
    async function loadModels() {
      const loadingText = document.getElementById('loading-text');
      const loadingProgress = document.getElementById('loading-progress');
      
      try {
        loadingText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI Models...';
        loadingProgress.textContent = '0%';

        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';
        
        loadingProgress.textContent = '20%';
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
        
        loadingProgress.textContent = '50%';
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        
        loadingProgress.textContent = '80%';
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        
        loadingProgress.textContent = '100%';
        loadingText.textContent = '‡πÇ‡∏´‡∏•‡∏î AI Models ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
        
        modelsLoaded = true;
        
        setTimeout(() => {
          document.getElementById('loading-overlay').style.display = 'none';
          document.getElementById('app').style.display = 'block';
        }, 500);
        
        return true;
      } catch (error) {
        loadingText.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î AI Models ‡πÑ‡∏î‡πâ';
        loadingProgress.textContent = 'Error: ' + error.message;
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î AI Models ‡πÑ‡∏î‡πâ', 'error');
        return false;
      }
    }

    // Extract Face Descriptor from Image
    async function extractFaceDescriptor(imageElement) {
      try {
        const detection = await faceapi
          .detectSingleFace(imageElement)
          .withFaceLandmarks()
          .withFaceDescriptor();
        
        if (!detection) {
          return null;
        }
        
        return detection.descriptor;
      } catch (error) {
        console.error('Error extracting face descriptor:', error);
        return null;
      }
    }

    // Compare Face Descriptors
    function compareFaces(descriptor1, descriptor2, threshold = 0.6) {
      const distance = faceapi.euclideanDistance(descriptor1, descriptor2);
      return {
        match: distance < threshold,
        distance: distance,
        confidence: Math.max(0, (1 - distance) * 100).toFixed(1)
      };
    }

    // Google Apps Script API Functions
    async function fetchRooms() {
      try {
        const response = await fetch(GAS_URL + '?action=getRooms&t=' + Date.now(), { method: 'GET', mode: 'cors', redirect: 'follow' });
        if (!response.ok) { throw new Error('HTTP ' + response.status); }
        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
        if (result.success) {
          ROOMS = result.data || [];
          updateRoomSelects();
          return true;
        } else {
          throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô');
        }
      } catch (error) {
        console.error('Fetch Rooms Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }

    async function fetchAttendanceReport(room, startDate, endDate) {
      try {
        const params = new URLSearchParams({ 
            action: 'getAttendance', 
            room: room, 
            startDate: startDate, 
            endDate: endDate, 
            t: Date.now() 
        });
        
        const response = await fetch(GAS_URL + '?' + params.toString(), { 
            method: 'GET', 
            mode: 'cors', 
            redirect: 'follow' 
        });
        if (!response.ok) { 
            throw new Error('HTTP ' + response.status); 
        }
        const text = await response.text();
        let result;
        try {
            result = JSON.parse(text);
        } catch (e) {
            console.error('Response text:', text.substring(0, 200));
            throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á');
        }
        
        if (result.success) {
            // Assume GAS sends back filtered records with 'id' and 'timestamp'
            return result.data || [];
        } 
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ');
        
      } catch (error) {
        console.error('Fetch Attendance Report Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return [];
      }
    }
    
    async function deleteAttendanceRecords(room, startDate, endDate) {
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                mode: 'cors',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'deleteAttendance',
                    room: room,
                    startDate: startDate,
                    endDate: endDate
                })
            });
            
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            const text = await response.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                console.error('Response text:', text.substring(0, 200));
                throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }

            if (result.success) {
                return true;
            } 
            throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
            
        } catch (error) {
            console.error('Delete Attendance Error:', error);
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            return false;
        }
    }

    function updateRoomSelects() {
      const selects = [
        document.getElementById('student-room'),
        document.getElementById('camera-student-room'),
        document.getElementById('attendance-room-select'),
        document.getElementById('list-room-filter'),
        document.getElementById('report-room-select')
      ];

      selects.forEach((select, index) => {
        const currentValue = select.value;
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå options ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ß‡πâ‡∏ô option ‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö placeholder)
        while (select.options.length > 1) {
          select.remove(1);
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° options ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
        ROOMS.forEach(room => {
          const option = document.createElement('option');
          option.value = room;
          option.textContent = room;
          select.appendChild(option);
        });

        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        if (ROOMS.includes(currentValue)) {
          select.value = currentValue;
        }
      });
    }

    async function fetchFaces() {
      try {
        const response = await fetch(GAS_URL + '?action=getFaces&t=' + Date.now(), { method: 'GET', mode: 'cors', redirect: 'follow' });
        if (!response.ok) { throw new Error('HTTP ' + response.status); }
        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á');
        }

        if (result.success) {
          storedFaces = result.data || [];
          // Extract face descriptors for all stored faces
          faceDescriptors = [];
          for (const face of storedFaces) {
            if (face.face_descriptor) {
              try {
                faceDescriptors.push({
                  id: face.id,
                  name: face.name,
                  room: face.room,
                  descriptor: new Float32Array(JSON.parse(face.face_descriptor))
                });
              } catch (e) {
                console.error('Error parsing face descriptor:', e);
              }
            }
          }
          renderFacesList();
          updateFaceCount();
          showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (' + storedFaces.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)', 'success');
        } else {
          throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ error');
        }
      } catch (error) {
        console.error('Fetch Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        renderFacesList();
        updateFaceCount();
      }
    }

    async function createFace(faceData) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          redirect: 'follow',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'createFace', ...faceData })
        });
        if (!response.ok) { throw new Error('HTTP ' + response.status); }
        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }

        if (result.success) {
          await fetchFaces();
          return true;
        }
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤');
      } catch (error) {
        console.error('Create Face Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }

    async function deleteFace(faceId) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          redirect: 'follow',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'deleteFace', id: faceId })
        });
        if (!response.ok) { throw new Error('HTTP ' + response.status); }
        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }

        if (result.success) {
          await fetchFaces();
          showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          return true;
        }
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
      } catch (error) {
        console.error('Delete Face Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }

    async function createAttendance(attendanceData) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          redirect: 'follow',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'createAttendance', attendance: attendanceData })
        });
        if (!response.ok) { throw new Error('HTTP ' + response.status); }
        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }

        if (result.success) {
          return true;
        }
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ');
      } catch (error) {
        console.error('Create Attendance Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }

    async function createRoom(roomName) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          redirect: 'follow',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'createRoom', name: roomName })
        });
        if (!response.ok) { throw new Error('HTTP ' + response.status); }
        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }

        if (result.success) {
          await fetchRooms();
          showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          return true;
        }
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ');
      } catch (error) {
        console.error('Create Room Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }

    async function deleteRoom(roomName) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          redirect: 'follow',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'deleteRoom', name: roomName })
        });
        if (!response.ok) { throw new Error('HTTP ' + response.status); }
        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }

        if (result.success) {
          await fetchRooms();
          showToast('‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          return true;
        }
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ');
      } catch (error) {
        console.error('Delete Room Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }

    // --- UI and General Functions ---

    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, duration);
    }

    function switchMainTab(tabName) {
      const tabs = ['attendance', 'register', 'report', 'list', 'rooms'];
      tabs.forEach(tab => {
        const section = document.getElementById(tab + '-section');
        const button = document.getElementById('main-tab-' + tab);

        if (tab === tabName) {
          section.classList.remove('hidden');
          button.style.backgroundColor = defaultConfig.primary_button_color;
          button.style.color = 'white';
        } else {
          section.classList.add('hidden');
          button.style.backgroundColor = 'transparent';
          button.style.color = defaultConfig.text_color;
        }
      });
      currentMainTab = tabName;
      localStorage.setItem('currentMainTab', tabName);
      
      // Stop cameras when switching tabs
      if (tabName !== 'attendance') {
        stopAttendanceCamera();
      }
      if (tabName !== 'register' || currentRegisterTab === 'upload') {
        stopRegisterCamera();
      }

      // Initial load for reports/lists when switching
      if (tabName === 'list') {
        renderFacesList();
      } else if (tabName === 'rooms') {
        renderRoomsList();
      }
    }

    function switchRegisterTab(tabName) {
      const tabs = ['upload', 'camera'];
      tabs.forEach(tab => {
        const section = document.getElementById('register-' + tab + '-section');
        const button = document.getElementById('register-tab-' + tab);

        if (tab === tabName) {
          section.classList.remove('hidden');
          button.style.backgroundColor = defaultConfig.primary_button_color;
          button.style.color = 'white';
        } else {
          section.classList.add('hidden');
          button.style.backgroundColor = 'transparent';
          button.style.color = defaultConfig.text_color;
          
          if (tab === 'upload') {
             stopRegisterCamera();
          }
        }
      });
      currentRegisterTab = tabName;
      localStorage.setItem('currentRegisterTab', tabName);
    }
    
    function renderFacesList() {
      const grid = document.getElementById('faces-grid');
      const roomFilter = selectedListRoomFilter;
      
      const filteredFaces = storedFaces.filter(face => roomFilter === '' || face.room === roomFilter);

      document.getElementById('face-count').textContent = filteredFaces.length;
      grid.innerHTML = ''; 

      if (filteredFaces.length === 0) {
        grid.innerHTML = '<p class="col-span-full text-center py-8 opacity-60">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
        return;
      }

      filteredFaces.forEach(face => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-md p-4 flex flex-col items-center border border-gray-200';
        
        const faceIdDisplay = String(face.id).substring(0, 4) + '...'; // ‡πÅ‡∏™‡∏î‡∏á ID ‡πÅ‡∏Ñ‡πà 4 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å

        card.innerHTML = `
          <div class="h-24 w-24 rounded-full overflow-hidden mb-3 bg-gray-200 flex items-center justify-center">
            ${face.base64_image ? 
              `<img src="${face.base64_image}" alt="${face.name}" class="h-full w-full object-cover">` :
              `<i class="fas fa-user-circle text-4xl text-gray-500"></i>`
            }
          </div>
          <p class="font-semibold text-center text-lg">${face.name}</p>
          <p class="text-sm text-gray-500 text-center">${face.room}</p>
          <p class="text-xs text-gray-400 mt-1">ID: ${faceIdDisplay}</p>
          <button class="mt-3 text-red-600 hover:text-red-800 text-sm delete-face-btn" data-id="${face.id}" data-name="${face.name}">üóëÔ∏è ‡∏•‡∏ö</button>
        `;
        grid.appendChild(card);
      });
      
      document.querySelectorAll('.delete-face-btn').forEach(button => {
          button.addEventListener('click', (e) => {
              const id = e.target.getAttribute('data-id');
              const name = e.target.getAttribute('data-name');
              showConfirmDeleteModal(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á "${name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?`, async () => {
                  await deleteFace(id);
              });
          });
      });
    }

    function renderRoomsList() {
        const list = document.getElementById('rooms-list');
        list.innerHTML = '';
        document.getElementById('room-count').textContent = ROOMS.length;

        if (ROOMS.length === 0) {
            list.innerHTML = '<p class="text-center py-8 opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>';
            return;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏ó‡∏¢
        const sortedRooms = [...ROOMS].sort((a, b) => a.localeCompare(b, 'th'));

        sortedRooms.forEach(room => {
            const card = document.createElement('div');
            card.className = 'bg-gray-50 p-4 rounded-lg flex justify-between items-center border';
            
            const studentsInRoom = storedFaces.filter(f => f.room === room).length;

            card.innerHTML = `
                <div class="flex flex-col">
                    <p class="font-semibold text-lg">${room}</p>
                    <p class="text-sm text-gray-500">${studentsInRoom} ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                </div>
                <button class="text-red-600 hover:text-red-800 text-sm delete-room-btn" data-room="${room}">üóëÔ∏è ‡∏•‡∏ö</button>
            `;
            list.appendChild(card);
        });

        document.querySelectorAll('.delete-room-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const roomName = e.target.getAttribute('data-room');
                const studentsCount = storedFaces.filter(f => f.room === roomName).length;
                let message = `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô "${roomName}"?`;
                if (studentsCount > 0) {
                    message += ` (‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${studentsCount} ‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô)`;
                }
                
                showConfirmDeleteModal(message, async () => {
                    await deleteRoom(roomName);
                });
            });
        });
    }

    function updateFaceCount() {
        document.getElementById('face-count').textContent = storedFaces.length;
    }
    
    // --- Camera Control Functions ---
    
    async function startCamera(videoId, facingMode, canvasId, switchBtnId) {
      const video = document.getElementById(videoId);
      const constraints = {
        video: {
          facingMode: facingMode,
          width: { ideal: 640 },
          height: { ideal: 480 }
        }
      };

      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        if (videoId === 'register-camera-video') {
            registerCameraStream = stream;
            currentRegisterFacingMode = facingMode;
            if (await checkAvailableCameras()) {
                document.getElementById('switch-register-camera-btn').classList.remove('hidden');
            }
        } else if (videoId === 'attendance-camera-video') {
            attendanceCameraStream = stream;
            currentAttendanceFacingMode = facingMode;
            if (await checkAvailableCameras()) {
                document.getElementById('switch-attendance-camera-btn').classList.remove('hidden');
            }
        }
        
        return stream;
      } catch (err) {
        console.error("Error accessing camera: ", err);
        showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + err.name, 'error');
        return null;
      }
    }

    function stopCamera(stream) {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    }

    function stopRegisterCamera() {
        stopCamera(registerCameraStream);
        registerCameraStream = null;
        
        document.getElementById('start-register-camera-btn').classList.remove('hidden');
        document.getElementById('capture-register-btn').classList.add('hidden');
        document.getElementById('save-register-btn').classList.add('hidden');
        document.getElementById('switch-register-camera-btn').classList.add('hidden');
        document.getElementById('captured-image-canvas').classList.add('hidden');
        
        const canvas = document.getElementById('register-camera-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    function stopAttendanceCamera() {
        clearInterval(attendanceDetectionInterval);
        stopCamera(attendanceCameraStream);
        attendanceCameraStream = null;
        
        document.getElementById('start-attendance-camera-btn').classList.remove('hidden');
        document.getElementById('stop-attendance-camera-btn').classList.add('hidden');
        document.getElementById('switch-attendance-camera-btn').classList.add('hidden');
        document.getElementById('save-attendance-btn').disabled = true;
        
        detectedStudents.clear();
        renderDetectedList();
        document.getElementById('attendance-count').textContent = '‡∏û‡∏ö 0 ‡∏Ñ‡∏ô';
        
        const canvas = document.getElementById('attendance-camera-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }


    // --- Attendance Logic ---
    
    function startAttendanceDetection() {
        if (attendanceDetectionInterval) return;

        const video = document.getElementById('attendance-camera-video');
        const canvas = document.getElementById('attendance-camera-canvas');
        
        const detectionIntervalTime = 500; // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡∏∏‡∏Å 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

        attendanceDetectionInterval = setInterval(async () => {
            if (video.paused || video.ended || !modelsLoaded) {
                return;
            }

            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);

            if (faceDescriptors.length === 0) {
                 // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏¢ ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '20px Sarabun';
                ctx.fillStyle = 'red';
                ctx.fillText('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô', 10, 50);
                return;
            }

            const detections = await faceapi
                .detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
                .withFaceLandmarks()
                .withFaceDescriptors();

            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let currentDetected = new Map();
            let newDetected = false;

            const labeledDescriptors = faceDescriptors.map(f => new faceapi.LabeledFaceDescriptors(f.name, [f.descriptor]));
            const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.7); // üí° ‡∏Ñ‡πà‡∏≤ Threshold 0.7 (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô)

            resizedDetections.forEach(detection => {
                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                const box = detection.detection.box;
                let name = bestMatch.label;
                let distance = bestMatch.distance;
                
                // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£
                if (name === 'unknown') {
                    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
                    ctx.strokeStyle = '#fde047'; 
                    ctx.lineWidth = 3;
                } else {
                    const matchedFace = faceDescriptors.find(f => f.name === name);
                    const studentId = matchedFace.id;
                    const studentRoom = matchedFace.room;
                    const studentName = matchedFace.name;
                    
                    ctx.strokeStyle = '#10b981'; 
                    ctx.lineWidth = 3;

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    if (studentRoom === selectedAttendanceRoom) {
                        currentDetected.set(studentId, {
                            id: studentId,
                            name: studentName,
                            room: studentRoom,
                            distance: distance.toFixed(2),
                            timestamp: Date.now()
                        });

                        // üí° NEW: Speech Synthesis and Throttle Logic
                        const now = Date.now();
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß
                        if (!detectedStudents.has(studentId) && (lastSpokenId !== studentId || now - lastSpokenTime > THROTTLE_TIME)) {
                             detectedStudents.set(studentId, {
                                id: studentId,
                                name: studentName,
                                room: studentRoom,
                                distance: distance.toFixed(2),
                                timestamp: now 
                            });
                            speakText(`${studentName} ‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß`);
                            lastSpokenId = studentId;
                            lastSpokenTime = now;
                            newDetected = true; 
                        }
                    } else {
                        // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                         ctx.strokeStyle = '#f97316'; 
                    }
                }
                
                // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö
                ctx.beginPath();
                ctx.rect(box.x, box.y, box.width, box.height);
                ctx.stroke();

                // ‡∏ß‡∏≤‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                const label = name === 'unknown' ? 'Unknown' : `${name} (${distance.toFixed(2)})`;
                ctx.fillStyle = ctx.strokeStyle;
                ctx.fillRect(box.x, box.y - 30, box.width, 30); 
                ctx.fillStyle = 'white';
                ctx.font = '20px Sarabun'; 
                ctx.fillText(label, box.x + 5, box.y - 10);
            });
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            if (newDetected) {
                renderDetectedList();
            }
            document.getElementById('attendance-count').textContent = `‡∏û‡∏ö ${detectedStudents.size} ‡∏Ñ‡∏ô`;
            document.getElementById('save-attendance-btn').disabled = detectedStudents.size === 0;

        }, detectionIntervalTime);
    }
    
    function renderDetectedList() {
        const listContainer = document.getElementById('detected-list');
        listContainer.innerHTML = '';
        
        if (detectedStudents.size === 0) {
            listContainer.innerHTML = '<p class="text-center py-8 opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</p>';
            return;
        }

        // ‡πÅ‡∏õ‡∏•‡∏á Map ‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
        const sortedStudents = Array.from(detectedStudents.values()).sort((a, b) => a.name.localeCompare(b.name, 'th'));

        sortedStudents.forEach(student => {
            const time = new Date(student.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm';
            item.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-semibold text-gray-800">${student.name}</span>
                    <span class="text-xs text-gray-500">${student.room} | ‡∏£‡∏∞‡∏¢‡∏∞: ${student.distance}</span>
                </div>
                <span class="text-sm font-medium text-green-600">${time}</span>
            `;
            listContainer.appendChild(item);
        });
    }

    // --- Report Section Logic (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°) ---

    let currentReportData = []; // for Excel export

    // üí° UPDATED: Main function to load and process report
    async function loadReport() {
        const room = document.getElementById('report-room-select').value;
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;

        if (!room) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
            return;
        }

        const loadBtn = document.getElementById('load-report-btn');
        const loadText = document.getElementById('load-report-text');
        const loadLoading = document.getElementById('load-report-loading');
        
        loadBtn.disabled = true;
        loadText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
        loadLoading.classList.remove('hidden');

        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const attendanceRecords = await fetchAttendanceReport(room, startDate, endDate);
        
        // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const studentsInRoom = storedFaces.filter(face => face.room === room);
        const totalStudents = studentsInRoom.length;

        // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ô‡∏±‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        const studentsAttendedOnce = new Set();
        attendanceRecords.forEach(record => {
            // ‡πÉ‡∏ä‡πâ record.id ‡πÄ‡∏û‡∏∑‡πà‡∏≠ match ‡∏Å‡∏±‡∏ö student.id ‡πÉ‡∏ô storedFaces
            studentsAttendedOnce.add(String(record.id)); 
        });
        
        const attendedStudentsCount = studentsAttendedOnce.size;
        const absentStudentsCount = totalStudents - attendedStudentsCount;

        // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ
        document.getElementById('total-students').textContent = totalStudents;
        document.getElementById('attended-students').textContent = attendedStudentsCount;
        document.getElementById('absent-students').textContent = absentStudentsCount;

        // 5. ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        renderReport(attendanceRecords, studentsInRoom); 
        
        document.getElementById('report-results').classList.remove('hidden');

        loadLoading.classList.add('hidden');
        loadText.textContent = 'üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°';
        loadBtn.disabled = false;
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }


    // üí° NEW: Function to render the detailed table report (Fixes the absence issue)
    function renderReport(records, studentsInRoom) {
        const body = document.getElementById('report-table-body');
        body.innerHTML = '';
        
        // Map: Student ID -> First Attendance Record (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á timestamp)
        const attendanceMap = new Map();
        records.forEach(record => {
            const studentId = String(record.id); 
            // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ record ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ID ‡∏ô‡∏±‡πâ‡∏ô‡πÜ (‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤
            if (!attendanceMap.has(studentId)) { 
                attendanceMap.set(studentId, record);
            }
        });

        if (studentsInRoom.length === 0) {
            body.innerHTML = '<tr><td colspan="6" class="text-center py-4 opacity-70">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
            currentReportData = [];
            return;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏ó‡∏¢
        studentsInRoom.sort((a, b) => a.name.localeCompare(b.name, 'th'));
        
        currentReportData = []; // Clear for new report data

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        studentsInRoom.forEach((student, index) => {
            const row = body.insertRow();
            const studentIdStr = String(student.id);
            const isAttended = attendanceMap.has(studentIdStr);
            const record = attendanceMap.get(studentIdStr);
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏µ
            const statusText = isAttended ? '‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°' : '‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°';
            const statusColor = isAttended ? '#10b981' : '#ef4444'; 
            
            let dateText = '-';
            let timeText = '-';
            
            if (isAttended && record) {
                // record.timestamp ‡∏Ñ‡∏∑‡∏≠ Date string/ISO string ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å GAS
                const dateObj = new Date(record.timestamp); 
                dateText = dateObj.toLocaleDateString('th-TH');
                timeText = dateObj.toLocaleTimeString('th-TH');
            }
            
            row.innerHTML = `
                <td class="border px-4 py-3">${index + 1}</td>
                <td class="border px-4 py-3">${student.name}</td>
                <td class="border px-4 py-3">${student.room}</td>
                <td class="border px-4 py-3 text-center" style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                <td class="border px-4 py-3 text-center">${dateText}</td>
                <td class="border px-4 py-3 text-center">${timeText}</td>
            `;
            
            // Collect data for Excel export
            currentReportData.push({ 
                no: index + 1, 
                name: student.name, 
                room: student.room, 
                status: statusText, 
                date: dateText, 
                time: timeText 
            });
        });
    }

    // --- Export Excel Logic ---

    function exportToExcel() {
        if (currentReportData.length === 0) {
            showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'error');
            return;
        }

        const data = currentReportData.map(item => [
            item.no,
            item.name,
            item.room,
            item.status,
            item.date,
            item.time
        ]);

        const header = ["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏ß‡∏•‡∏≤"];
        data.unshift(header);

        // Simple CSV generation (for cross-browser compatibility)
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for BOM (Thai support)
        data.forEach(rowArray => {
            let row = rowArray.map(item => `"${item}"`).join(",");
            csvContent += row + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        const roomName = document.getElementById('report-room-select').value;
        const dateRange = document.getElementById('report-start-date').value + '_to_' + document.getElementById('report-end-date').value;
        link.setAttribute("download", `Report_${roomName}_${dateRange}.csv`);
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
        showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (CSV) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    // --- Initial Config and Event Listeners ---
    
    function onConfigChange(config) {
      document.body.style.backgroundColor = config.background_color;
      document.querySelectorAll('.rounded-lg.shadow-lg').forEach(el => {
        el.style.backgroundColor = config.card_color;
      });
      document.body.style.color = config.text_color;
      document.body.style.fontFamily = config.font_family;
      document.body.style.fontSize = config.font_size + 'px';
      
      const primaryButtons = [
          document.getElementById('main-tab-attendance'),
          document.getElementById('main-tab-register'),
          document.getElementById('main-tab-report'),
          document.getElementById('main-tab-list'),
          document.getElementById('main-tab-rooms'),
          document.getElementById('save-url-btn'),
          document.getElementById('add-button'),
          document.getElementById('add-room-button'),
          document.getElementById('capture-register-btn'),
          document.getElementById('save-register-btn'),
          document.getElementById('start-register-camera-btn'),
          document.getElementById('start-attendance-camera-btn'),
          document.getElementById('load-report-btn')
      ];
      
      primaryButtons.forEach(btn => {
          if (btn.id !== 'main-tab-' + currentMainTab) {
               btn.style.backgroundColor = config.primary_button_color;
               btn.style.color = 'white';
          }
      });
      
      const redButtons = [
          document.getElementById('delete-attendance-btn'),
          document.getElementById('confirm-delete-confirm')
      ];
      
      redButtons.forEach(btn => {
          btn.style.backgroundColor = config.secondary_button_color;
      });
      
      // Update attendance button
      document.getElementById('attendance-summary').style.backgroundColor = config.primary_button_color;
      document.getElementById('save-attendance-btn').style.backgroundColor = config.primary_button_color;
      document.getElementById('save-attendance-btn').style.color = 'white';
      
      // Update current active tab color
      switchMainTab(currentMainTab);
      switchRegisterTab(currentRegisterTab);
    }
    
    document.getElementById('change-url-btn').addEventListener('click', () => {
        document.getElementById('gas-url-input').value = GAS_URL;
        document.getElementById('config-modal').style.display = 'flex';
    });
    
    document.getElementById('save-url-btn').addEventListener('click', () => {
        const newUrl = document.getElementById('gas-url-input').value.trim();
        if (newUrl && newUrl.endsWith('/exec')) {
            localStorage.setItem('gas_url', newUrl);
            GAS_URL = newUrl;
            document.getElementById('config-modal').style.display = 'none';
            // Reload app with new URL
            location.reload(); 
        } else {
            showToast('URL ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec', 'error');
        }
    });


    // Main Tab Switching
    document.getElementById('main-tab-attendance').addEventListener('click', () => switchMainTab('attendance'));
    document.getElementById('main-tab-register').addEventListener('click', () => switchMainTab('register'));
    document.getElementById('main-tab-report').addEventListener('click', () => switchMainTab('report'));
    document.getElementById('main-tab-list').addEventListener('click', () => switchMainTab('list'));
    document.getElementById('main-tab-rooms').addEventListener('click', () => switchMainTab('rooms'));

    // Register Tab Switching
    document.getElementById('register-tab-upload').addEventListener('click', () => switchRegisterTab('upload'));
    document.getElementById('register-tab-camera').addEventListener('click', () => switchRegisterTab('camera'));

    // --- Register Events ---
    document.getElementById('face-image').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('image-preview').src = event.target.result;
                document.getElementById('preview-container').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById('preview-container').classList.add('hidden');
        }
    });
    
    document.getElementById('add-face-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('person-name').value;
        const room = document.getElementById('student-room').value;
        const fileInput = document.getElementById('face-image');
        
        if (!name || !room || fileInput.files.length === 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
            return;
        }

        const btnText = document.getElementById('add-button-text');
        const btnLoading = document.getElementById('add-loading');
        
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        document.getElementById('add-button').disabled = true;

        const reader = new FileReader();
        reader.onload = async (event) => {
            const base64Image = event.target.result;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Image element ‡∏à‡∏≤‡∏Å Base64 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ face-api ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
            const img = new Image();
            img.onload = async () => {
                const descriptor = await extractFaceDescriptor(img);
                
                if (descriptor) {
                    const success = await createFace({
                        name: name,
                        room: room,
                        base64_image: base64Image,
                        face_descriptor: JSON.stringify(Array.from(descriptor))
                    });
                    
                    if (success) {
                        document.getElementById('add-face-form').reset();
                        document.getElementById('preview-container').classList.add('hidden');
                    }
                } else {
                    showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î', 'error');
                }
                
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                document.getElementById('add-button').disabled = false;
            };
            img.src = base64Image;
        };
        reader.readAsDataURL(fileInput.files[0]);
    });
    
    // --- Register Camera Events ---

    document.getElementById('start-register-camera-btn').addEventListener('click', async () => {
        const stream = await startCamera('register-camera-video', currentRegisterFacingMode, 'register-camera-canvas', 'switch-register-camera-btn');
        if (stream) {
            document.getElementById('start-register-camera-btn').classList.add('hidden');
            document.getElementById('capture-register-btn').classList.remove('hidden');
            document.getElementById('captured-image-canvas').classList.add('hidden');
            document.getElementById('save-register-btn').classList.add('hidden');

             // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÇ‡∏´‡∏•‡∏î
            document.getElementById('register-camera-video').onloadedmetadata = () => {
                const video = document.getElementById('register-camera-video');
                const canvas = document.getElementById('register-camera-canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                detectFaceForRegister();
            };
        }
    });

    document.getElementById('switch-register-camera-btn').addEventListener('click', async () => {
        stopCamera(registerCameraStream);
        const newFacingMode = currentRegisterFacingMode === 'user' ? 'environment' : 'user';
        currentRegisterFacingMode = newFacingMode;
        
        const stream = await startCamera('register-camera-video', currentRegisterFacingMode, 'register-camera-canvas', 'switch-register-camera-btn');
        if (stream) {
            document.getElementById('captured-image-canvas').classList.add('hidden');
            document.getElementById('save-register-btn').classList.add('hidden');
            document.getElementById('capture-register-btn').classList.remove('hidden');
        }
    });

    // Capture (take photo)
    document.getElementById('capture-register-btn').addEventListener('click', () => {
        const video = document.getElementById('register-camera-video');
        const captureCanvas = document.getElementById('captured-image-canvas');
        
        captureCanvas.width = video.videoWidth;
        captureCanvas.height = video.videoHeight;
        
        const ctx = captureCanvas.getContext('2d');
        ctx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
        
        capturedImageData = captureCanvas.toDataURL('image/jpeg');
        
        document.getElementById('captured-image-canvas').classList.remove('hidden');
        document.getElementById('save-register-btn').classList.remove('hidden');
        document.getElementById('capture-register-btn').classList.add('hidden');
        
        const detectionCanvas = document.getElementById('register-camera-canvas');
        const dCtx = detectionCanvas.getContext('2d');
        dCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
    });
    
    // Save Captured Photo
    document.getElementById('save-register-btn').addEventListener('click', async () => {
        const name = document.getElementById('camera-person-name').value;
        const room = document.getElementById('camera-student-room').value;
        
        if (!name || !room) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô', 'error');
            return;
        }

        const btnText = document.getElementById('save-register-btn');
        btnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        btnText.disabled = true;
        
        const capturedImage = document.getElementById('captured-image-canvas');
        
        // 1. Extract Descriptor
        const descriptor = await extractFaceDescriptor(capturedImage);
        
        if (descriptor) {
            // 2. Save to GAS
            const success = await createFace({
                name: name,
                room: room,
                base64_image: capturedImageData,
                face_descriptor: JSON.stringify(Array.from(descriptor))
            });
            
            if (success) {
                document.getElementById('camera-person-name').value = '';
                document.getElementById('camera-student-room').value = '';
                document.getElementById('captured-image-canvas').classList.add('hidden');
                document.getElementById('save-register-btn').classList.add('hidden');
                document.getElementById('capture-register-btn').classList.remove('hidden'); // ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ï‡πà‡∏≠
            }
        } else {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ', 'error');
            document.getElementById('capture-register-btn').classList.remove('hidden');
        }

        btnText.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        btnText.disabled = false;
    });

    // Face detection for register mode (visual aid)
    function detectFaceForRegister() {
        const video = document.getElementById('register-camera-video');
        const canvas = document.getElementById('register-camera-canvas');
        
        const runDetection = () => {
            if (!registerCameraStream || document.getElementById('register-camera-section').classList.contains('hidden') || currentRegisterTab !== 'camera' || document.getElementById('capture-register-btn').classList.contains('hidden')) {
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô
            }

            faceapi
                .detectSingleFace(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
                .withFaceLandmarks()
                .then(detection => {
                    const displaySize = { width: video.videoWidth, height: video.videoHeight };
                    faceapi.matchDimensions(canvas, displaySize);
                    
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    if (detection) {
                        const resizedDetection = faceapi.resizeResults(detection, displaySize);
                        const box = resizedDetection.detection.box;
                        
                        ctx.strokeStyle = '#3b82f6';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.rect(box.x, box.y, box.width, box.height);
                        ctx.stroke();
                        
                        ctx.fillStyle = '#3b82f6';
                        ctx.fillRect(box.x, box.y - 25, box.width, 25);
                        ctx.fillStyle = 'white';
                        ctx.font = '18px Sarabun'; 
                        ctx.fillText('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û', box.x + 5, box.y - 5);
                    }
                    
                    requestAnimationFrame(runDetection);
                })
                .catch(err => {
                    console.error('Detection error:', err);
                    requestAnimationFrame(runDetection);
                });
        };
        
        video.addEventListener('play', runDetection, { once: true });
        if (!video.paused && !video.ended) {
            runDetection();
        }
    }


    // --- Attendance Camera Events ---

    document.getElementById('attendance-room-select').addEventListener('change', (e) => {
        selectedAttendanceRoom = e.target.value;
        document.getElementById('attendance-camera-section').classList.toggle('hidden', selectedAttendanceRoom === '');
        stopAttendanceCamera(); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á
    });

    document.getElementById('start-attendance-camera-btn').addEventListener('click', async () => {
        if (!selectedAttendanceRoom) {
             showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'error');
             return;
        }
        
        const stream = await startCamera('attendance-camera-video', currentAttendanceFacingMode, 'attendance-camera-canvas', 'switch-attendance-camera-btn');
        if (stream) {
            document.getElementById('start-attendance-camera-btn').classList.add('hidden');
            document.getElementById('stop-attendance-camera-btn').classList.remove('hidden');

             // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÇ‡∏´‡∏•‡∏î
            document.getElementById('attendance-camera-video').onloadedmetadata = () => {
                const video = document.getElementById('attendance-camera-video');
                const canvas = document.getElementById('attendance-camera-canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                startAttendanceDetection();
            };
        }
    });

    document.getElementById('switch-attendance-camera-btn').addEventListener('click', async () => {
        stopAttendanceCamera();
        const newFacingMode = currentAttendanceFacingMode === 'user' ? 'environment' : 'user';
        currentAttendanceFacingMode = newFacingMode;
        
        const stream = await startCamera('attendance-camera-video', currentAttendanceFacingMode, 'attendance-camera-canvas', 'switch-attendance-camera-btn');
        if (stream) {
            document.getElementById('attendance-camera-video').onloadedmetadata = () => {
                 const video = document.getElementById('attendance-camera-video');
                const canvas = document.getElementById('attendance-camera-canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                startAttendanceDetection();
            };
            document.getElementById('start-attendance-camera-btn').classList.add('hidden');
            document.getElementById('stop-attendance-camera-btn').classList.remove('hidden');
        }
    });

    document.getElementById('stop-attendance-camera-btn').addEventListener('click', stopAttendanceCamera);

    document.getElementById('save-attendance-btn').addEventListener('click', async () => {
        if (detectedStudents.size === 0) return;

        const btnText = document.getElementById('save-attendance-text');
        const btnLoading = document.getElementById('save-attendance-loading');
        
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        document.getElementById('save-attendance-btn').disabled = true;
        
        // ‡πÅ‡∏õ‡∏•‡∏á Map ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ GAS
        const attendanceData = Array.from(detectedStudents.values()).map(student => ({
             id: student.id,
             name: student.name,
             room: student.room,
             timestamp: student.timestamp 
        }));

        const success = await createAttendance(attendanceData);

        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
        
        if (success) {
            showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${attendanceData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
            detectedStudents.clear();
            renderDetectedList();
            document.getElementById('attendance-count').textContent = '‡∏û‡∏ö 0 ‡∏Ñ‡∏ô';
            document.getElementById('save-attendance-btn').disabled = true;
        } else {
             document.getElementById('save-attendance-btn').disabled = false; // ‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
        }
    });

    // --- List Section Events ---
    document.getElementById('list-room-filter').addEventListener('change', (e) => {
        selectedListRoomFilter = e.target.value;
        renderFacesList();
    });

    // --- Room Management Events ---

    document.getElementById('add-room-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const roomName = document.getElementById('new-room-name').value.trim();
        
        if (!roomName) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô', 'error');
            return;
        }

        const btnText = document.getElementById('add-room-button-text');
        const btnLoading = document.getElementById('add-room-loading');
        
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        document.getElementById('add-room-button').disabled = true;

        const success = await createRoom(roomName);

        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
        document.getElementById('add-room-button').disabled = false;
        
        if (success) {
            document.getElementById('new-room-name').value = '';
            renderRoomsList();
        }
    });

    // --- Report Events ---

    document.getElementById('load-report-btn').addEventListener('click', loadReport);

    document.getElementById('delete-attendance-btn').addEventListener('click', () => {
        const room = document.getElementById('report-room-select').value;
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;

        if (!room || !startDate || !endDate) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
            return;
        }

        const message = `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á "${room}" ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${startDate} ‡∏ñ‡∏∂‡∏á ${endDate}? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ`;
        
        showConfirmDeleteModal(message, async () => {
            const success = await deleteAttendanceRecords(room, startDate, endDate);
            if (success) {
                showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö
                await loadReport();
            }
        });
    });

    document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);


    // --- Initialization ---
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('report-start-date').value = today;
    document.getElementById('report-end-date').value = today;
    
    async function initApp() {
        if (!GAS_URL || !GAS_URL.endsWith('/exec')) {
            document.getElementById('config-modal').style.display = 'flex';
            document.getElementById('loading-overlay').style.display = 'none';
            return;
        }

        // 1. Load Face-API Models
        const modelsSuccess = await loadModels();
        if (!modelsSuccess) {
            return;
        }

        // 2. Load Data from GAS
        const roomSuccess = await fetchRooms();
        if (roomSuccess) {
            await fetchFaces();
        }
        
        // 3. Apply Theme/Config and Setup UI
        if (window.elementSdk) {
            window.elementSdk.applyInitialConfig(defaultConfig, onConfigChange);
        } else {
            onConfigChange(defaultConfig);
        }
        
        // 4. Restore last tab
        const lastTab = localStorage.getItem('currentMainTab') || 'attendance';
        switchMainTab(lastTab);
        
        const lastRegisterTab = localStorage.getItem('currentRegisterTab') || 'upload';
        switchRegisterTab(lastRegisterTab);
    }


    if (typeof faceapi !== 'undefined') {
      initApp();
    } else {
      window.addEventListener('load', initApp);
    }
  </script>
<div class="p-4 sm:p-6 bg-gray-50/50 border-t border-gray-200/50 text-center text-xs sm:text-sm text-gray-600 rounded-b-2xl">
    <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç (Face Scan)</p>
</div>
</body>
</html>
