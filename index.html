<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç (Face Scan)</title>
  </head>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" referrerpolicy="no-referrer" rel="stylesheet">
<script src="/_sdk/element_sdk.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
    }
    html {
      height: 100%;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    .toast.success {
      background-color: #10b981;
    }
    .toast.error {
      background-color: #ef4444;
    }
    .toast.info {
      background-color: #3b82f6;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .config-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .config-modal-content {
      background: white;
      padding: 32px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      color: white;
    }
    .loading-overlay .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2500;
      animation: fadeIn 0.2s ease-out;
    }
    .confirm-modal-content {
      background: white;
      padding: 32px;
      border-radius: 16px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .camera-container {
      width: 100%;
      aspect-ratio: 4/3;
      background: #000;
      border-radius: 0.5rem;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .camera-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .camera-container canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
  </style>
<style>@view-transition { navigation: auto; }</style>
<script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</link><script>
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof defaultConfig !== "undefined" && defaultConfig.app_title) {
        document.title = defaultConfig.app_title;
      }
    });
    </script></head>
<body><!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
<div class="spinner"></div>
<p class="text-xl font-semibold" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI Models...</p>
<p class="text-sm mt-2" id="loading-progress">0%</p>
</div><!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script URL -->
<div class="config-modal" id="config-modal" style="display: none;">
<div class="config-modal-content">
<h2 class="text-2xl font-bold mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script</h2>
<p class="mb-4 text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App</p><input class="w-full px-4 py-2 border rounded-lg mb-4" id="gas-url-input" placeholder="https://script.google.com/a/macros/cmi.nfe.go.th/s/AKfycbyL5RxlIF_JFYPBlKZS6ZRo7CoCa3tXibtN25FNuPUKVaFtCQbtn2XhZJLClbNmqU9HSg/exec" type="text"/> <button class="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700" id="save-url-btn"> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL </button>
<p class="mt-4 text-sm text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: URL ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ "Who has access" ‡πÄ‡∏õ‡πá‡∏ô "Anyone"</p>
</div>
</div><!-- Confirm Delete Modal -->
<div class="confirm-modal" id="confirm-delete-modal" style="display: none;">
<div class="confirm-modal-content">
<h2 class="text-2xl font-bold mb-4 text-center" style="color: #ef4444;">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h2>
<p class="mb-6 text-center text-gray-700 text-lg" id="confirm-delete-message"></p>
<div class="flex gap-3"><button class="flex-1 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="confirm-delete-cancel"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button class="flex-1 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors" id="confirm-delete-confirm"> ‡∏•‡∏ö </button>
</div>
</div>
</div>
<div class="min-h-full p-6" id="app" style="display: none;">
<div class="max-w-6xl mx-auto">
<div class="flex justify-between items-center mb-8">
<h1 class="text-4xl font-bold" id="app-title">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç (Face Scan)</h1><button class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700" id="change-url-btn"> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL </button>
</div><!-- Main Tabs -->
<div class="flex gap-2 mb-6"><button class="flex-1 py-3 px-6 rounded-lg font-semibold transition-colors" id="main-tab-attendance">‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</button> <button class="flex-1 py-3 px-6 rounded-lg font-semibold transition-colors" id="main-tab-register">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button> <button class="flex-1 py-3 px-6 rounded-lg font-semibold transition-colors" id="main-tab-report">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</button> <button class="flex-1 py-3 px-6 rounded-lg font-semibold transition-colors" id="main-tab-list">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button> <button class="flex-1 py-3 px-6 rounded-lg font-semibold transition-colors" id="main-tab-rooms">üè´ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
</div><!-- Attendance Section -->
<div class="hidden" id="attendance-section">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</h2><select class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:outline-none text-lg" id="attendance-room-select"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option> </select>
</div>
<div class="hidden" id="attendance-camera-section">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><!-- Camera Area -->
<div class="lg:col-span-2 p-6 rounded-lg shadow-lg">
<h2 class="text-2xl font-semibold mb-4">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h2>
<div class="camera-container mb-4">
<video autoplay="" class="w-full h-full object-cover" id="attendance-camera-video" muted="" playsinline=""></video>
<canvas class="absolute top-0 left-0 w-full h-full pointer-events-none" id="attendance-camera-canvas"></canvas>
</div>
<div class="px-6 py-3 rounded-lg font-bold text-center shadow-lg mb-4" id="attendance-summary" style="background-color: rgba(16, 185, 129, 0.95); color: white;"><span id="attendance-count">‡∏û‡∏ö 0 ‡∏Ñ‡∏ô</span>
</div>
<div class="flex gap-2"><button class="flex-1 py-5 rounded-lg font-semibold transition-colors" id="start-attendance-camera-btn"> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á </button> <button class="py-5 px-6 rounded-lg font-semibold transition-colors hidden" id="switch-attendance-camera-btn"> üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á </button> <button class="flex-1 py-5 rounded-lg font-semibold transition-colors hidden" id="stop-attendance-camera-btn"> ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á </button>
</div>
</div><!-- Detected List Area -->
<div class="p-6 rounded-lg shadow-lg">
<h2 class="text-2xl font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö</h2>
<div class="space-y-2 mb-4 max-h-96 overflow-y-auto" id="detected-list">
<p class="text-center py-8 opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</p>
</div><button class="w-full py-5 rounded-lg font-semibold transition-colors" disabled="" id="save-attendance-btn"> <span id="save-attendance-text">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
<div class="loading-spinner mx-auto hidden" id="save-attendance-loading"></div></button>
</div>
</div>
</div>
</div><!-- Register Section -->
<div class="hidden" id="register-section">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h2><!-- Sub Tabs for Register -->
<div class="flex gap-2 mb-4"><button class="flex-1 py-5 px-6 rounded-lg font-semibold transition-colors" id="register-tab-upload">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</button> <button class="flex-1 py-5 px-6 rounded-lg font-semibold transition-colors" id="register-tab-camera">‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
</div><!-- Upload Register Section -->
<div id="register-upload-section">
<form class="space-y-4" id="add-face-form">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div><label class="block text-sm font-medium mb-2" for="person-name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> <input class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none" id="person-name" required="" type="text"/>
</div>
<div><label class="block text-sm font-medium mb-2" for="student-room">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label> <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none" id="student-room" required=""> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option> </select>
</div>
</div>
<div><label class="block text-sm font-medium mb-2" for="face-image">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label> <input accept="image/*" class="w-full px-4 py-2 border rounded-lg" id="face-image" required="" type="file"/>
</div>
<div class="hidden" id="preview-container"><img class="w-full h-48 object-cover rounded-lg" id="image-preview"/>
</div><button class="w-full py-3 rounded-lg font-semibold transition-colors" id="add-button" type="submit"> <span id="add-button-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
<div class="loading-spinner mx-auto hidden" id="add-loading"></div></button>
</form>
</div><!-- Camera Register Section -->
<div class="hidden space-y-4" id="register-camera-section">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div><label class="block text-sm font-medium mb-2" for="camera-person-name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> <input class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none" id="camera-person-name" type="text"/>
</div>
<div><label class="block text-sm font-medium mb-2" for="camera-student-room">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label> <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none" id="camera-student-room"> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option> </select>
</div>
</div>
<div class="camera-container">
<video autoplay="" class="w-full h-full object-cover" id="register-camera-video" muted="" playsinline=""></video>
<canvas class="absolute top-0 left-0 w-full h-full pointer-events-none" id="register-camera-canvas"></canvas>
</div>
<div class="flex gap-2"><button class="flex-1 py-3 rounded-lg font-semibold transition-colors" id="start-register-camera-btn"> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á </button> <button class="py-3 px-4 rounded-lg font-semibold transition-colors hidden" id="switch-register-camera-btn"> üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á </button> <button class="flex-1 py-3 rounded-lg font-semibold transition-colors hidden" id="capture-register-btn"> üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û </button> <button class="flex-1 py-3 rounded-lg font-semibold transition-colors hidden" id="save-register-btn"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å </button>
</div>
<canvas class="w-full rounded-lg hidden" id="captured-image-canvas" style="aspect-ratio: 4/3; object-fit: cover;"></canvas>
</div>
</div>
</div><!-- Report Section -->
<div class="hidden" id="report-section">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
<div><label class="block text-sm font-medium mb-2" for="report-room-select">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label> <select class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:outline-none text-lg" id="report-room-select"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option> </select>
</div>
<div><label class="block text-sm font-medium mb-2" for="report-start-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label> <input class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:outline-none" id="report-start-date" type="date"/>
</div>
<div><label class="block text-sm font-medium mb-2" for="report-end-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label> <input class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:outline-none" id="report-end-date" type="date"/>
</div>
</div><button class="w-full py-4 rounded-lg font-bold text-lg transition-colors shadow-lg hover:shadow-xl" id="load-report-btn"> <span id="load-report-text">üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</span>
<div class="loading-spinner mx-auto hidden" id="load-report-loading"></div></button>
</div>
<div class="hidden" id="report-results">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="p-4 rounded-lg text-center" style="background-color: rgba(59, 130, 246, 0.1);">
<p class="text-sm opacity-70">‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</p>
<p class="text-3xl font-bold mt-2" id="total-students">0</p>
</div>
<div class="p-4 rounded-lg text-center" style="background-color: rgba(16, 185, 129, 0.1);">
<p class="text-sm opacity-70">‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
<p class="text-3xl font-bold mt-2" id="attended-students" style="color: #10b981;">0</p>
</div>
<div class="p-4 rounded-lg text-center" style="background-color: rgba(239, 68, 68, 0.1);">
<p class="text-sm opacity-70">‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
<p class="text-3xl font-bold mt-2" id="absent-students" style="color: #ef4444;">0</p>
</div>
</div>
</div>
<div class="p-6 rounded-lg shadow-lg mb-6">
<div class="flex justify-between items-center mb-4">
<h2 class="text-2xl font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</h2>
<div class="flex gap-2"><button class="px-6 py-3 rounded-lg font-bold transition-colors shadow-md hover:shadow-lg" id="export-excel-btn" style="background-color: #10b981; color: white;"> üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel </button> <button class="px-6 py-3 rounded-lg font-bold transition-colors shadow-md hover:shadow-lg" id="delete-attendance-btn" style="background-color: #ef4444; color: white;"> üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
</div>
</div>
<div class="overflow-x-auto">
<table class="w-full border-collapse" id="report-table">
<thead>
<tr style="background-color: rgba(59, 130, 246, 0.1);">
<th class="border px-4 py-3 text-left">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
<th class="border px-4 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
<th class="border px-4 py-3 text-left">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>
<th class="border px-4 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
<th class="border px-4 py-3 text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
<th class="border px-4 py-3 text-center">‡πÄ‡∏ß‡∏•‡∏≤</th>
</tr>
</thead>
<tbody id="report-table-body">
</tbody>
</table>
</div>
</div>
</div>
</div><!-- List Section -->
<div class="hidden" id="list-section">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h2><select class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:outline-none text-lg" id="list-room-filter"> <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option> </select>
</div>
<div class="p-6 rounded-lg shadow-lg">
<h2 class="text-2xl font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (<span id="face-count">0</span>)</h2>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="faces-grid">
<p class="col-span-full text-center py-8 opacity-60">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
</div>
</div>
</div><!-- Rooms Management Section -->
<div class="hidden" id="rooms-section">
<div class="p-6 rounded-lg shadow-lg mb-6">
<h2 class="text-2xl font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
<form class="space-y-4" id="add-room-form">
<div><label class="block text-sm font-medium mb-2" for="new-room-name">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label> <input class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none" id="new-room-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤" required="" type="text"/>
</div><button class="w-full py-3 rounded-lg font-semibold transition-colors" id="add-room-button" type="submit"> <span id="add-room-button-text">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</span>
<div class="loading-spinner mx-auto hidden" id="add-room-loading"></div></button>
</form>
</div>
<div class="p-6 rounded-lg shadow-lg">
<h2 class="text-2xl font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (<span id="room-count">0</span>)</h2>
<div class="space-y-2" id="rooms-list">
<p class="text-center py-8 opacity-60">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
</div>
</div>
</div>
</div>
</div>
<script>
    const defaultConfig = {
      background_color: "#f0f9ff",
      card_color: "#ffffff",
      text_color: "#1e293b",
      primary_button_color: "#3b82f6",
      secondary_button_color: "#ef4444",
      app_title: "‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç (Face Scan)",
      register_button_text: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
      attendance_button_text: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°",
      font_family: "Sarabun, sans-serif",
      font_size: 16
    };

    let ROOMS = [];
    let storedFaces = [];
    let registerCameraStream = null;
    let attendanceCameraStream = null;
    let currentMainTab = 'attendance';
    let currentRegisterTab = 'upload';
    let pendingImageData = null;
    let capturedImageData = null;
    let currentRegisterFacingMode = 'user';
    let currentAttendanceFacingMode = 'user';
    let availableCameras = [];
    let GAS_URL = localStorage.getItem('gas_url') || 'https://script.google.com/macros/s/AKfycbzcROiJNZ-5AQbDYbPs_l2-hoKurM5Cxpt_knt_ufYGp9jOfOGY9qlyMAdiMynmHAD7oA/exec';
    let modelsLoaded = false;
    let faceDescriptors = [];
    let attendanceDetectionInterval = null;
    let detectedStudents = new Map();
    let selectedAttendanceRoom = '';
    let selectedListRoomFilter = '';
    let pendingDeleteAction = null;
    
    // --- NEW Code for Speech and Throttle ---
    let lastSpokenId = null; // ID ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    let lastSpokenTime = 0;
    const THROTTLE_TIME = 30000; // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Text-to-Speech)
    function speakText(text) {
        if ('speechSynthesis' in window) {
            // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            window.speechSynthesis.cancel(); 
            
            const speech = new SpeechSynthesisUtterance(text);
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏©‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
            const voices = window.speechSynthesis.getVoices();
            const thaiVoice = voices.find(voice => voice.lang === 'th-TH' || voice.name.includes('Thai'));
            
            if (thaiVoice) {
                speech.voice = thaiVoice;
            } else {
                console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (th-TH) ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ó‡∏ô");
            }
            
            speech.lang = 'th-TH';
            speech.rate = 1.0; 
            speech.pitch = 1.0;
            
            window.speechSynthesis.speak(speech);
        } else {
            console.error("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Speech Synthesis API.");
        }
    }
    // ----------------------------------------


    // Confirm Delete Modal Functions
    function showConfirmDeleteModal(message, onConfirm) {
      document.getElementById('confirm-delete-message').textContent = message;
      document.getElementById('confirm-delete-modal').style.display = 'flex';
      pendingDeleteAction = onConfirm;
    }

    function hideConfirmDeleteModal() {
      document.getElementById('confirm-delete-modal').style.display = 'none';
      pendingDeleteAction = null;
    }

    document.getElementById('confirm-delete-cancel').addEventListener('click', hideConfirmDeleteModal);

    document.getElementById('confirm-delete-confirm').addEventListener('click', async () => {
      if (pendingDeleteAction) {
        hideConfirmDeleteModal();
        await pendingDeleteAction();
      }
    });

    // Check available cameras
    async function checkAvailableCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        availableCameras = devices.filter(device => device.kind === 'videoinput');
        return availableCameras.length > 1;
      } catch (error) {
        console.error('Error checking cameras:', error);
        return false;
      }
    }

    // Load Face-API.js Models
    async function loadModels() {
      const loadingText = document.getElementById('loading-text');
      const loadingProgress = document.getElementById('loading-progress');
      
      try {
        loadingText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI Models...';
        loadingProgress.textContent = '0%';

        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';
        
        loadingProgress.textContent = '20%';
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
        
        loadingProgress.textContent = '50%';
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        
        loadingProgress.textContent = '80%';
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        
        loadingProgress.textContent = '100%';
        loadingText.textContent = '‡πÇ‡∏´‡∏•‡∏î AI Models ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
        
        modelsLoaded = true;
        
        setTimeout(() => {
          document.getElementById('loading-overlay').style.display = 'none';
          document.getElementById('app').style.display = 'block';
        }, 500);
        
        return true;
      } catch (error) {
        loadingText.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î AI Models ‡πÑ‡∏î‡πâ';
        loadingProgress.textContent = 'Error: ' + error.message;
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î AI Models ‡πÑ‡∏î‡πâ', 'error');
        return false;
      }
    }

    // Extract Face Descriptor from Image
    async function extractFaceDescriptor(imageElement) {
      try {
        const detection = await faceapi
          .detectSingleFace(imageElement)
          .withFaceLandmarks()
          .withFaceDescriptor();
        
        if (!detection) {
          return null;
        }
        
        return detection.descriptor;
      } catch (error) {
        console.error('Error extracting face descriptor:', error);
        return null;
      }
    }

    // Compare Face Descriptors
    function compareFaces(descriptor1, descriptor2, threshold = 0.6) {
      const distance = faceapi.euclideanDistance(descriptor1, descriptor2);
      return {
        match: distance < threshold,
        distance: distance,
        confidence: Math.max(0, (1 - distance) * 100).toFixed(1)
      };
    }

    // Google Apps Script API Functions
    async function fetchRooms() {
      try {
        const response = await fetch(GAS_URL + '?action=getRooms&t=' + Date.now(), {
          method: 'GET',
          mode: 'cors',
          redirect: 'follow'
        });
        
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        
        const text = await response.text();
        
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
        
        if (result.success) {
          ROOMS = result.data || [];
          updateRoomSelects();
          return true;
        } else {
          throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ error');
        }
      } catch (error) {
        console.error('Fetch Rooms Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }

    async function fetchAttendanceReport(room, startDate, endDate) {
      try {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡πà‡∏ô‡∏ä‡∏µ‡∏ï Attendance_<‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á>
        const params = new URLSearchParams({
          action: 'getAttendance',
          room: room,
          t: Date.now()
        });
        
        const response = await fetch(GAS_URL + '?' + params.toString(), {
          method: 'GET',
          mode: 'cors',
          redirect: 'follow'
        });
        
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        
        const text = await response.text();
        
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
        
        if (result.success) {
          let records = result.data || [];
          
          // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏
          if (startDate && endDate) {
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            records = records.filter(record => {
              const recordDate = new Date(record.timestamp);
              return recordDate >= start && recordDate <= end;
            });
          }
          
          return records;
        } else {
          throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ error');
        }
      } catch (error) {
        console.error('Fetch Attendance Report Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return [];
      }
    }

    function updateRoomSelects() {
      const selects = [
        document.getElementById('student-room'),
        document.getElementById('camera-student-room'),
        document.getElementById('attendance-room-select'),
        document.getElementById('list-room-filter'),
        document.getElementById('report-room-select')
      ];

      selects.forEach((select, index) => {
        const currentValue = select.value;
        
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå options ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ß‡πâ‡∏ô option ‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö placeholder)
        while (select.options.length > 1) {
          select.remove(1);
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° options ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
        ROOMS.forEach(room => {
          const option = document.createElement('option');
          option.value = room;
          option.textContent = room;
          select.appendChild(option);
        });
        
        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        if (ROOMS.includes(currentValue)) {
          select.value = currentValue;
        }
      });
    }

    async function fetchFaces() {
      try {
        const response = await fetch(GAS_URL + '?action=getFaces&t=' + Date.now(), {
          method: 'GET',
          mode: 'cors',
          redirect: 'follow'
        });
        
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        
        const text = await response.text();
        
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á');
        }
        
        if (result.success) {
          storedFaces = result.data || [];
          
          // Extract face descriptors for all stored faces
          faceDescriptors = [];
          for (const face of storedFaces) {
            if (face.face_descriptor) {
              try {
                faceDescriptors.push({
                  id: face.id,
                  name: face.name,
                  room: face.room,
                  descriptor: new Float32Array(JSON.parse(face.face_descriptor))
                });
              } catch (e) {
                console.error('Error parsing face descriptor:', e);
              }
            }
          }
          
          renderFacesList();
          updateFaceCount();
          showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (' + storedFaces.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)', 'success');
        } else {
          throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ error');
        }
      } catch (error) {
        console.error('Fetch Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        renderFacesList();
        updateFaceCount();
      }
    }

    async function createFace(faceData) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          redirect: 'follow',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'createFace',
            ...faceData
          })
        });
        
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        
        const text = await response.text();
        
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
        
        if (result.success) {
          await fetchFaces();
          return true;
        }
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ error');
      } catch (error) {
        console.error('Create Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }

    async function saveAttendance(attendanceData) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          redirect: 'follow',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'saveAttendance',
            room: selectedAttendanceRoom,
            records: attendanceData
          })
        });
        
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        
        const text = await response.text();
        
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
        
        if (result.success) {
          // *** ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Logic ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ***
          return true;
        }
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ error');
      } catch (error) {
        console.error('Save Attendance Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }
    
    async function deleteFace(faceId) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          redirect: 'follow',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'deleteFace',
            id: String(faceId)
          })
        });
        
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        
        const text = await response.text();
        
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
        
        if (result.success) {
          await fetchFaces();
          return true;
        }
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ error');
      } catch (error) {
        console.error('Delete Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }
    async function createRoom(roomName) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          redirect: 'follow',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'createRoom',
            room_name: roomName
          })
        });
        
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        
        const text = await response.text();
        
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
        
        if (result.success) {
          await fetchRooms();
          return true;
        }
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ error');
      } catch (error) {
        console.error('Create Room Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }

    async function deleteRoom(roomName) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          redirect: 'follow',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'deleteRoom',
            room_name: roomName
          })
        });
        
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        
        const text = await response.text();
        
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Response text:', text.substring(0, 200));
          throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
        
        if (result.success) {
          await fetchRooms();
          return true;
        }
        throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ error');
      } catch (error) {
        console.error('Delete Room Error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        return false;
      }
    }

    function renderFacesList() {
      const gridContainer = document.getElementById('faces-grid');
      gridContainer.innerHTML = '';
      
      let facesToRender = storedFaces;
      if (selectedListRoomFilter) {
        facesToRender = storedFaces.filter(face => face.room === selectedListRoomFilter);
      }

      if (facesToRender.length === 0) {
        gridContainer.innerHTML = '<p class="col-span-full text-center py-8 opacity-60">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
        return;
      }

      facesToRender.forEach(face => {
        const card = createFaceCard(face);
        gridContainer.appendChild(card);
      });
    }

    function createFaceCard(face) {
      const card = document.createElement('div');
      card.dataset.faceId = face.id;
      card.className = 'relative rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-shadow';
      card.style.backgroundColor = window.elementSdk?.config?.card_color || defaultConfig.card_color;
      card.innerHTML = `
        <img src="${face.image_data}" alt="${face.name}" class="w-full h-32 object-cover">
        <div class="p-3">
          <p class="font-semibold text-center truncate" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">${face.name}</p>
          <p class="text-xs text-center opacity-70" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">${face.room || '-'}</p>
        </div>
        <button class="delete-btn absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center font-bold shadow-lg hover:opacity-80 transition-opacity" style="background-color: ${window.elementSdk?.config?.secondary_button_color || defaultConfig.secondary_button_color}; color: white;">√ó</button>
      `;
      
     const deleteBtn = card.querySelector('.delete-btn');
      
      deleteBtn.addEventListener('click', async () => { // <--- Event Listener ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô async
    
    const faceName = face.name; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
    const faceId = face.id; // ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô

    // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
    deleteBtn.disabled = true;
    deleteBtn.textContent = '...';
    
    // 2. ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
    const success = await deleteFace(faceId);
    
    // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    if (success) {
        showToast(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${faceName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        await fetchFaces(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    } else {
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        deleteBtn.disabled = false;
        deleteBtn.textContent = '√ó';
    }
});
// ...
      return card;
    }

    function updateFaceCount() {
      let count = storedFaces.length;
      if (selectedListRoomFilter) {
        count = storedFaces.filter(face => face.room === selectedListRoomFilter).length;
      }
      document.getElementById('face-count').textContent = count;
    }

    function renderRoomsList() {
      const listContainer = document.getElementById('rooms-list');
      listContainer.innerHTML = '';

      if (ROOMS.length === 0) {
        listContainer.innerHTML = '<p class="text-center py-8 opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
        document.getElementById('room-count').textContent = '0';
        return;
      }

      ROOMS.forEach(roomName => {
        const item = document.createElement('div');
        item.className = 'flex justify-between items-center p-4 rounded-lg shadow-sm';
        item.style.backgroundColor = window.elementSdk?.config?.card_color || defaultConfig.card_color;
        item.innerHTML = `
          <span class="text-lg font-medium" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">${roomName}</span>
          <button class="delete-room-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors" data-room="${roomName}" style="background-color: ${window.elementSdk?.config?.secondary_button_color || defaultConfig.secondary_button_color}; color: white;">‡∏•‡∏ö</button>
        `;
        listContainer.appendChild(item);
      });

      document.querySelectorAll('.delete-room-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          const roomName = e.target.dataset.room;
          
          showConfirmDeleteModal(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô: <strong>${roomName}</strong> ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, async () => {
            button.disabled = true;
            button.textContent = '...';

            const success = await deleteRoom(roomName);

            if (success) {
              showToast(`‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô "${roomName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
              renderRoomsList(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
              await fetchFaces(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤/‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            } else {
              showToast('‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
              button.disabled = false;
              button.textContent = '‡∏•‡∏ö'; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
            }
          });
        });
      });
      document.getElementById('room-count').textContent = ROOMS.length;
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    let currentReportData = [];

    async function loadReport() {
      const room = document.getElementById('report-room-select').value;
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;

      if (!room) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô', 'error');
        return;
      }
      if (!startDate || !endDate) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'error');
        return;
      }

      const loadBtn = document.getElementById('load-report-btn');
      const loadText = document.getElementById('load-report-text');
      const loadLoading = document.getElementById('load-report-loading');
      loadBtn.disabled = true;
      loadText.classList.add('hidden');
      loadLoading.classList.remove('hidden');

      const attendanceRecords = await fetchAttendanceReport(room, startDate, endDate);

      loadBtn.disabled = false;
      loadText.classList.remove('hidden');
      loadLoading.classList.add('hidden');

      const studentsInRoom = storedFaces.filter(face => face.room === room);
      const totalStudents = studentsInRoom.length;
      
      // Group attendance records by student ID and date
      const attendanceByStudentIdAndDate = new Map();
      attendanceRecords.forEach(record => {
          const key = `${record.student_id}_${record.date}`;
          if (!attendanceByStudentIdAndDate.has(key)) {
              attendanceByStudentIdAndDate.set(key, record);
          }
      });

      // Find all unique dates in the report range
      const datesInRange = [];
      let currentDate = new Date(startDate);
      const end = new Date(endDate);
      while (currentDate <= end) {
          datesInRange.push(currentDate.toISOString().split('T')[0]);
          currentDate.setDate(currentDate.getDate() + 1);
      }
      
      // Calculate overall statistics based on at least one check-in within the period
      const attendedStudentIds = new Set(attendanceRecords.map(record => record.student_id));
      const attendedCount = attendedStudentIds.size;
      const absentCount = totalStudents - attendedCount;

      document.getElementById('total-students').textContent = totalStudents;
      document.getElementById('attended-students').textContent = attendedCount;
      document.getElementById('absent-students').textContent = absentCount;

      currentReportData = [];
      const tableBody = document.getElementById('report-table-body');
      tableBody.innerHTML = '';
      
      const config = window.elementSdk?.config || defaultConfig;
      const textColor = config.text_color || defaultConfig.text_color;
      let rowIndex = 1;

      // Render rows for all students in the room
      studentsInRoom.forEach(student => {
          // Check attendance status for all dates in range
          datesInRange.forEach(dateStr => {
              const recordKey = `${student.id}_${dateStr}`;
              const record = attendanceByStudentIdAndDate.get(recordKey);
              
              const date = new Date(dateStr + 'T07:00:00Z'); // Use a fixed time to avoid timezone issues with date input
              const dateThai = date.toLocaleDateString('th-TH');

              if (record) {
                  // Attended
                  const timestamp = new Date(record.timestamp);
                  const timeThai = timestamp.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                  const row = document.createElement('tr');
                  row.style.borderBottom = '1px solid #eee';
                  row.innerHTML = `
                      <td class="border px-4 py-3" style="color: ${textColor}">${rowIndex}</td>
                      <td class="border px-4 py-3" style="color: ${textColor}">${student.name}</td>
                      <td class="border px-4 py-3" style="color: ${textColor}">${student.room}</td>
                      <td class="border px-4 py-3 text-center font-semibold" style="color: #10b981;">‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</td>
                      <td class="border px-4 py-3 text-center" style="color: ${textColor}">${dateThai}</td>
                      <td class="border px-4 py-3 text-center" style="color: ${textColor}">${timeThai}</td>
                  `;
                  tableBody.appendChild(row);
                  currentReportData.push({ no: rowIndex, name: student.name, room: student.room, status: '‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°', date: dateThai, time: timeThai });
              } else {
                  // Absent
                  const row = document.createElement('tr');
                  row.style.borderBottom = '1px solid #eee';
                  row.innerHTML = `
                      <td class="border px-4 py-3" style="color: ${textColor}">${rowIndex}</td>
                      <td class="border px-4 py-3" style="color: ${textColor}">${student.name}</td>
                      <td class="border px-4 py-3" style="color: ${textColor}">${student.room}</td>
                      <td class="border px-4 py-3 text-center font-semibold" style="color: #ef4444;">‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</td>
                      <td class="border px-4 py-3 text-center" style="color: ${textColor}">${dateThai}</td>
                      <td class="border px-4 py-3 text-center" style="color: ${textColor}">-</td>
                  `;
                  tableBody.appendChild(row);
                  currentReportData.push({ no: rowIndex, name: student.name, room: student.room, status: '‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°', date: dateThai, time: '-' });
              }
              rowIndex++;
          });
      });

      document.getElementById('report-results').classList.remove('hidden');
      showToast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function exportToExcel() {
      if (currentReportData.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'error');
        return;
      }
      const room = document.getElementById('report-room-select').value;
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;

      let csv = '\uFEFF';
      csv += `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°\n`;
      csv += `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô: ${room}\n`;
      csv += `‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${startDate} ‡∏ñ‡∏∂‡∏á ${endDate}\n`;
      csv += `‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${document.getElementById('total-students').textContent} ‡∏Ñ‡∏ô\n`;
      csv += `‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°: ${document.getElementById('attended-students').textContent} ‡∏Ñ‡∏ô\n`;
      csv += `‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°: ${document.getElementById('absent-students').textContent} ‡∏Ñ‡∏ô\n\n`;
      csv += '‡∏•‡∏≥‡∏î‡∏±‡∏ö,‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤\n';

      currentReportData.forEach(row => {
        csv += `${row.no},"${row.name}","${row.room}","${row.status}","${row.date}","${row.time}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°_${room}_${startDate}_${endDate}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    async function deleteAttendanceData() {
        const room = document.getElementById('report-room-select').value;
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const deleteBtn = document.getElementById('delete-attendance-btn'); 

        if (!room || !startDate || !endDate) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
            return;
        }

        const startDateObj = new Date(startDate);
        const endDateObj = new Date(endDate);
        const startDateThai = startDateObj.toLocaleDateString('th-TH');
        const endDateThai = endDateObj.toLocaleDateString('th-TH');

        showConfirmDeleteModal(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô <strong>${room}</strong> ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <strong>${startDateThai} ‡∏ñ‡∏∂‡∏á ${endDateThai}</strong> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`, async () => {
            deleteBtn.disabled = true;
            deleteBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'deleteAttendance',
                        room: room,
                        start_timestamp: startDateObj.getTime(),
                        end_timestamp: endDateObj.getTime()
                    })
                });

                const text = await response.text();
                const result = JSON.parse(text);

                if (result.success) {
                    showToast(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${result.deleted_count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                    // Reload report after deletion
                    await loadReport();
                } else {
                    showToast(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Delete Attendance Error:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        });
    }

    // Tab Management Functions
    function switchMainTab(tab) {
      currentMainTab = tab;
      localStorage.setItem('currentMainTab', tab);
      const registerSection = document.getElementById('register-section');
      const attendanceSection = document.getElementById('attendance-section');
      const reportSection = document.getElementById('report-section');
      const listSection = document.getElementById('list-section');
      const roomsSection = document.getElementById('rooms-section');
      const tabRegister = document.getElementById('main-tab-register');
      const tabAttendance = document.getElementById('main-tab-attendance');
      const tabReport = document.getElementById('main-tab-report');
      const tabList = document.getElementById('main-tab-list');
      const tabRooms = document.getElementById('main-tab-rooms');
      
      const config = window.elementSdk?.config || defaultConfig;
      const primaryColor = config.primary_button_color || defaultConfig.primary_button_color;
      const textColor = config.text_color || defaultConfig.text_color;

      // Reset all tabs/sections
      [registerSection, attendanceSection, reportSection, listSection, roomsSection].forEach(section => section.classList.add('hidden'));
      [tabRegister, tabAttendance, tabReport, tabList, tabRooms].forEach(tabBtn => {
        tabBtn.style.backgroundColor = 'transparent';
        tabBtn.style.color = textColor;
        tabBtn.style.border = `2px solid ${textColor}`;
      });

      // Activate selected tab
      if (tab === 'register') {
        registerSection.classList.remove('hidden');
        tabRegister.style.backgroundColor = primaryColor;
        tabRegister.style.color = 'white';
        tabRegister.style.border = 'none';
        stopAttendanceCamera();
      } else if (tab === 'attendance') {
        attendanceSection.classList.remove('hidden');
        tabAttendance.style.backgroundColor = primaryColor;
        tabAttendance.style.color = 'white';
        tabAttendance.style.border = 'none';
        stopRegisterCamera();
      } else if (tab === 'report') {
        reportSection.classList.remove('hidden');
        tabReport.style.backgroundColor = primaryColor;
        tabReport.style.color = 'white';
        tabReport.style.border = 'none';
        stopRegisterCamera();
        stopAttendanceCamera();
      } else if (tab === 'list') {
        listSection.classList.remove('hidden');
        tabList.style.backgroundColor = primaryColor;
        tabList.style.color = 'white';
        tabList.style.border = 'none';
        stopRegisterCamera();
        stopAttendanceCamera();
      } else if (tab === 'rooms') {
        roomsSection.classList.remove('hidden');
        tabRooms.style.backgroundColor = primaryColor;
        tabRooms.style.color = 'white';
        tabRooms.style.border = 'none';
        stopRegisterCamera();
        stopAttendanceCamera();
      }
    }

    function switchRegisterTab(tab) {
      currentRegisterTab = tab;
      const uploadSection = document.getElementById('register-upload-section');
      const cameraSection = document.getElementById('register-camera-section');
      const tabUpload = document.getElementById('register-tab-upload');
      const tabCamera = document.getElementById('register-tab-camera');
      
      const config = window.elementSdk?.config || defaultConfig;
      const primaryColor = config.primary_button_color || defaultConfig.primary_button_color;
      const textColor = config.text_color || defaultConfig.text_color;
      
      [uploadSection, cameraSection].forEach(section => section.classList.add('hidden'));
      
      [tabUpload, tabCamera].forEach(tabBtn => {
        tabBtn.style.backgroundColor = 'transparent';
        tabBtn.style.color = textColor;
        tabBtn.style.border = `2px solid ${textColor}`;
      });

      if (tab === 'upload') {
        uploadSection.classList.remove('hidden');
        tabUpload.style.backgroundColor = primaryColor;
        tabUpload.style.color = 'white';
        tabUpload.style.border = 'none';
        stopRegisterCamera();
      } else if (tab === 'camera') {
        cameraSection.classList.remove('hidden');
        tabCamera.style.backgroundColor = primaryColor;
        tabCamera.style.color = 'white';
        tabCamera.style.border = 'none';
      }
    }
    
    // Register Camera Functions
    async function startRegisterCamera() {
      const video = document.getElementById('register-camera-video');
      const canvas = document.getElementById('register-camera-canvas');
      
      try {
        registerCameraStream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: currentRegisterFacingMode,
            aspectRatio: 4/3 
          } 
        });
        
        video.srcObject = registerCameraStream;
        video.play();
        
        document.getElementById('start-register-camera-btn').classList.add('hidden');
        document.getElementById('capture-register-btn').classList.remove('hidden');
        
        // Show switch button only if multiple cameras are available
        if (await checkAvailableCameras()) {
            document.getElementById('switch-register-camera-btn').classList.remove('hidden');
        }

        // Set canvas size when video is loaded
        video.addEventListener('loadedmetadata', () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        });

        showToast('‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } catch (error) {
        console.error('Camera error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + error.message, 'error');
      }
    }

    async function switchRegisterCamera() {
      currentRegisterFacingMode = currentRegisterFacingMode === 'user' ? 'environment' : 'user';
      stopRegisterCamera();
      await startRegisterCamera();
    }

    function stopRegisterCamera() {
      if (registerCameraStream) {
        registerCameraStream.getTracks().forEach(track => track.stop());
        registerCameraStream = null;
        const video = document.getElementById('register-camera-video');
        video.srcObject = null;
        
        document.getElementById('start-register-camera-btn').classList.remove('hidden');
        document.getElementById('switch-register-camera-btn').classList.add('hidden');
        document.getElementById('capture-register-btn').classList.add('hidden');
        document.getElementById('save-register-btn').classList.add('hidden');
        document.getElementById('captured-image-canvas').classList.add('hidden');
        
        const canvas = document.getElementById('register-camera-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        capturedImageData = null;
      }
    }

    function captureRegisterImage() {
      const video = document.getElementById('register-camera-video');
      const canvas = document.getElementById('captured-image-canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      
      capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
      canvas.classList.remove('hidden');
      document.getElementById('save-register-btn').classList.remove('hidden');
      
      showToast('‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    async function saveRegisterImage() {
      const name = document.getElementById('camera-person-name').value.trim();
      const room = document.getElementById('camera-student-room').value;
      
      if (!name) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 'error'); return; }
      if (!room) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô', 'error'); return; }
      if (!capturedImageData) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô', 'error'); return; }
      
      const saveBtn = document.getElementById('save-register-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      
      try {
        const img = new Image();
        img.onload = async () => {
          const descriptor = await extractFaceDescriptor(img);
          
          if (!descriptor) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô', 'error');
            saveBtn.disabled = false;
            saveBtn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            return;
          }

          // Re-scale and compress the captured image for storage
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          const maxWidth = 400;
          const maxHeight = 400;
          let width = img.width;
          let height = img.height;

          if (width > height) {
              if (width > maxWidth) {
                  height *= maxWidth / width;
                  width = maxWidth;
              }
          } else {
              if (height > maxHeight) {
                  width *= maxHeight / height;
                  height = maxHeight;
              }
          }

          tempCanvas.width = width;
          tempCanvas.height = height;
          tempCtx.drawImage(img, 0, 0, width, height);
          const compressedImageData = tempCanvas.toDataURL('image/jpeg', 0.7);

          const newFace = {
            id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
            name: name,
            room: room,
            image_data: compressedImageData,
            face_descriptor: JSON.stringify(Array.from(descriptor)),
            created_at: new Date().toISOString()
          };

          const success = await createFace(newFace);
          
          if (success) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            stopRegisterCamera(); // Stop camera after successful save
            document.getElementById('camera-person-name').value = '';
            document.getElementById('camera-student-room').value = '';
          }
        };
        img.src = capturedImageData;

      } catch (e) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      }
    }


    // Attendance Camera Functions
    function handleAttendanceRoomChange() {
      selectedAttendanceRoom = document.getElementById('attendance-room-select').value;
      
      // Stop/Reset camera if changing room while active
      if (attendanceCameraStream) {
          stopAttendanceCamera();
      }
      
      // Clear detected list when room changes
      detectedStudents.clear();
      updateDetectedList();

      if (selectedAttendanceRoom) {
        document.getElementById('attendance-camera-section').classList.remove('hidden');
        document.getElementById('start-attendance-camera-btn').classList.remove('hidden');
      } else {
        document.getElementById('attendance-camera-section').classList.add('hidden');
      }
    }

    async function startAttendanceCamera() {
      const video = document.getElementById('attendance-camera-video');
      const canvas = document.getElementById('attendance-camera-canvas');
      
      if (faceDescriptors.length === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠', 'error');
        return;
      }
      
      try {
        attendanceCameraStream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: currentAttendanceFacingMode,
            aspectRatio: 4/3
          } 
        });
        
        video.srcObject = attendanceCameraStream;
        video.play();
        
        document.getElementById('start-attendance-camera-btn').classList.add('hidden');
        document.getElementById('stop-attendance-camera-btn').classList.remove('hidden');
        
        if (await checkAvailableCameras()) {
            document.getElementById('switch-attendance-camera-btn').classList.remove('hidden');
        }
        
        video.addEventListener('loadedmetadata', () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          startAttendanceDetection();
        });
        
        showToast('‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤', 'success');

      } catch (error) {
        console.error('Camera error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + error.message, 'error');
      }
    }

    async function switchAttendanceCamera() {
      currentAttendanceFacingMode = currentAttendanceFacingMode === 'user' ? 'environment' : 'user';
      stopAttendanceCamera();
      await startAttendanceCamera();
    }

    function stopAttendanceCamera() {
      if (attendanceCameraStream) {
        attendanceCameraStream.getTracks().forEach(track => track.stop());
        attendanceCameraStream = null;
        const video = document.getElementById('attendance-camera-video');
        video.srcObject = null;
        
        document.getElementById('start-attendance-camera-btn').classList.remove('hidden');
        document.getElementById('switch-attendance-camera-btn').classList.add('hidden');
        document.getElementById('stop-attendance-camera-btn').classList.add('hidden');
        
        stopAttendanceDetection();
        
        const canvas = document.getElementById('attendance-camera-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    function startAttendanceDetection() {
      if (attendanceDetectionInterval) {
        clearInterval(attendanceDetectionInterval);
      }
      attendanceDetectionInterval = setInterval(async () => {
        await detectAttendanceFaces();
      }, 500); // Detect every 500ms
    }

    function stopAttendanceDetection() {
      if (attendanceDetectionInterval) {
        clearInterval(attendanceDetectionInterval);
        attendanceDetectionInterval = null;
      }
    }

    // *** IMPORTANT: Core Detection Logic Modified for Instant Speech ***
    async function detectAttendanceFaces() {
      const video = document.getElementById('attendance-camera-video');
      const canvas = document.getElementById('attendance-camera-canvas');
      const ctx = canvas.getContext('2d');

      if (!video.videoWidth || !modelsLoaded || faceDescriptors.length === 0 || !selectedAttendanceRoom) {
        return;
      }

      // Filter face descriptors by selected room
      const roomFaceDescriptors = faceDescriptors.filter(face => face.room === selectedAttendanceRoom);
      if (roomFaceDescriptors.length === 0) {
        // If no students in the room, still show the camera but skip detection
        return; 
      }

      try {
        const detections = await faceapi
          .detectAllFaces(video)
          .withFaceLandmarks()
          .withFaceDescriptors();

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (detections.length > 0) {
          
          // Create a FaceMatcher for this frame
          const labeledDescriptors = roomFaceDescriptors.map(face => 
              new faceapi.LabeledFaceDescriptors(face.name, [face.descriptor])
          );
          const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6); // 0.6 is the default distance threshold

          detections.forEach(detection => {
            const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
            
            // Draw box and label for detected face (regardless of match for visual feedback)
            const box = detection.detection.box;
            
            // Default color for ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤/no match
            let boxColor = '#ef4444'; // Red for ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
            let label = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤'; 
            
            if (bestMatch.label !== '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤' && bestMatch.distance < 0.6) {
                
                // Match Found
                const matchedFace = roomFaceDescriptors.find(f => f.name === bestMatch.label);
                
                if (matchedFace) {
                    boxColor = '#10b981'; // Green for known face
                    label = `${matchedFace.name} (${(1 - bestMatch.distance).toFixed(2)})`;
                    
                    // --- NEW Instant Speech and Save Logic START ---
                    const currentTime = Date.now();
                    const studentId = matchedFace.id;

                    // Check if student is NOT already in the detected list AND meets the throttle time
                   if (!detectedStudents.has(studentId) && (currentTime - lastSpokenTime > THROTTLE_TIME)) {
                        
                        // 1. Speak the name (*** ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ***)
                        // ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏° 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
                        const fullName = matchedFace.name; // <--- ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°
                        const speechText = ` ${fullName} ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`; // <--- ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°
                        speakText(speechText);
                        // 2. Update throttle variables
                        lastSpokenId = studentId;
                        lastSpokenTime = currentTime;
                        
                        // 3. Add to detected list
                        detectedStudents.set(studentId, { 
                            id: studentId, 
                            name: matchedFace.name, 
                            room: matchedFace.room,
                            timestamp: new Date().toISOString()
                        });
                        updateDetectedList();
                    }
                    // --- NEW Instant Speech and Save Logic END ---
                }
            }
            
            // Draw box
            ctx.strokeStyle = boxColor;
            ctx.lineWidth = 3;
            ctx.strokeRect(box.x, box.y, box.width, box.height);

            // Draw label
            ctx.fillStyle = boxColor;
            ctx.font = '24px Sarabun';
            ctx.fillText(label, box.x + 5, box.y + box.height + 25);
            
          });
          
        }
        
        // Update detected count summary
        document.getElementById('attendance-count').textContent = `‡∏û‡∏ö ${detectedStudents.size} ‡∏Ñ‡∏ô`;

      } catch (error) {
        console.error('Detection error:', error);
      }
    }
    // *** END: Core Detection Logic ***


    function updateDetectedList() {
      const listContainer = document.getElementById('detected-list');
      listContainer.innerHTML = '';

      if (detectedStudents.size === 0) {
        listContainer.innerHTML = '<p class="text-center py-8 opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</p>';
        document.getElementById('save-attendance-btn').disabled = true;
        return;
      }

      const config = window.elementSdk?.config || defaultConfig;
      const textColor = config.text_color || defaultConfig.text_color;

      // Sort by timestamp (newest first)
      const sortedStudents = Array.from(detectedStudents.values()).sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );

      sortedStudents.forEach(student => {
        const item = document.createElement('div');
        item.className = 'p-3 rounded-lg shadow-sm';
        item.style.backgroundColor = config.card_color || defaultConfig.card_color;
        item.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <p class="font-semibold" style="color: ${textColor}">${student.name}</p>
              <p class="text-xs opacity-70" style="color: ${textColor}">${student.room}</p>
              <p class="text-xs opacity-50" style="color: ${textColor}">${new Date(student.timestamp).toLocaleTimeString('th-TH')}</p>
            </div>
            <button class="remove-detected-btn text-xl font-bold opacity-50 hover:opacity-100" style="color: ${config.secondary_button_color || defaultConfig.secondary_button_color}" data-id="${student.id}">√ó</button>
          </div>
        `;
        listContainer.appendChild(item);
      });

      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-detected-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          detectedStudents.delete(id);
          updateDetectedList();
        });
      });
      
      document.getElementById('save-attendance-btn').disabled = false;
      document.getElementById('attendance-count').textContent = `‡∏û‡∏ö ${detectedStudents.size} ‡∏Ñ‡∏ô`;
    }

    async function saveAttendanceRecord() {
      if (detectedStudents.size === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö', 'error');
        return;
      }
      
      const saveBtn = document.getElementById('save-attendance-btn');
      const saveBtnText = document.getElementById('save-attendance-text');
      const saveLoading = document.getElementById('save-attendance-loading');
      
      saveBtn.disabled = true;
      saveBtnText.classList.add('hidden');
      saveLoading.classList.remove('hidden');

      const records = Array.from(detectedStudents.values());
      
      // Filter out only the necessary fields for GAS
      const dataToSave = records.map(r => ({
          id: r.id,
          name: r.name,
          room: r.room,
          timestamp: r.timestamp
      }));

      const success = await saveAttendance(dataToSave);
      
      saveBtn.disabled = false;
      saveBtnText.classList.remove('hidden');
      saveLoading.classList.add('hidden');

      if (success) {
        showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${records.length} ‡∏Ñ‡∏ô)`, 'success');
        detectedStudents.clear();
        updateDetectedList();
      }
    }

    // Event Listeners
    document.getElementById('main-tab-register').addEventListener('click', () => switchMainTab('register'));
    document.getElementById('main-tab-attendance').addEventListener('click', () => switchMainTab('attendance'));
    document.getElementById('main-tab-report').addEventListener('click', () => switchMainTab('report'));
    document.getElementById('main-tab-list').addEventListener('click', () => switchMainTab('list'));
    document.getElementById('main-tab-rooms').addEventListener('click', () => switchMainTab('rooms'));

    document.getElementById('load-report-btn').addEventListener('click', loadReport);
    document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
    document.getElementById('delete-attendance-btn').addEventListener('click', deleteAttendanceData);

    document.getElementById('attendance-room-select').addEventListener('change', handleAttendanceRoomChange);
    document.getElementById('start-attendance-camera-btn').addEventListener('click', startAttendanceCamera);
    document.getElementById('stop-attendance-camera-btn').addEventListener('click', stopAttendanceCamera);
    document.getElementById('switch-attendance-camera-btn').addEventListener('click', switchAttendanceCamera);
    document.getElementById('save-attendance-btn').addEventListener('click', saveAttendanceRecord);

    document.getElementById('register-tab-upload').addEventListener('click', () => switchRegisterTab('upload'));
    document.getElementById('register-tab-camera').addEventListener('click', () => switchRegisterTab('camera'));
    
    document.getElementById('start-register-camera-btn').addEventListener('click', startRegisterCamera);
    document.getElementById('switch-register-camera-btn').addEventListener('click', switchRegisterCamera);
    document.getElementById('capture-register-btn').addEventListener('click', captureRegisterImage);
    document.getElementById('save-register-btn').addEventListener('click', saveRegisterImage);

    document.getElementById('add-face-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('person-name').value.trim();
      const room = document.getElementById('student-room').value;
      
      if (!name) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 'error'); return; }
      if (!room) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô', 'error'); return; }
      if (!pendingImageData) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error'); return; }
      
      const addButton = document.getElementById('add-button');
      const addButtonText = document.getElementById('add-button-text');
      const addLoading = document.getElementById('add-loading');

      addButton.disabled = true;
      addButtonText.classList.add('hidden');
      addLoading.classList.remove('hidden');

      try {
        const img = new Image();
        img.onload = async () => {
          const descriptor = await extractFaceDescriptor(img);
          
          if (!descriptor) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô', 'error');
            addButton.disabled = false;
            addButtonText.classList.remove('hidden');
            addLoading.classList.add('hidden');
            return;
          }

          // Re-scale and compress the image for storage
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const maxWidth = 400;
          const maxHeight = 400;
          let width = img.width;
          let height = img.height;

          if (width > height) {
              if (width > maxWidth) {
                  height *= maxWidth / width;
                  width = maxWidth;
              }
          } else {
              if (height > maxHeight) {
                  width *= maxHeight / height;
                  height = maxHeight;
              }
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          const compressedImageData = canvas.toDataURL('image/jpeg', 0.7);

          const newFace = {
            id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
            name: name,
            room: room,
            image_data: compressedImageData,
            face_descriptor: JSON.stringify(Array.from(descriptor)),
            created_at: new Date().toISOString()
          };

          const success = await createFace(newFace);
          
          addButton.disabled = false;
          addButtonText.classList.remove('hidden');
          addLoading.classList.add('hidden');

          if (success) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            document.getElementById('add-face-form').reset();
            document.getElementById('preview-container').classList.add('hidden');
            pendingImageData = null;
          }
        };
        img.onerror = () => {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
          addButton.disabled = false;
          addButtonText.classList.remove('hidden');
          addLoading.classList.add('hidden');
        };
        img.src = pendingImageData;
      } catch (e) {
        console.error('Add Face Error:', e);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        addButton.disabled = false;
        addButtonText.classList.remove('hidden');
        addLoading.classList.add('hidden');
      }
    });

    document.getElementById('face-image').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          pendingImageData = event.target.result;
          document.getElementById('image-preview').src = pendingImageData;
          document.getElementById('preview-container').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        pendingImageData = null;
        document.getElementById('image-preview').src = '';
        document.getElementById('preview-container').classList.add('hidden');
      }
    });

    document.getElementById('add-room-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const roomName = document.getElementById('new-room-name').value.trim();
      if (!roomName) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô', 'error');
        return;
      }

      const addButton = document.getElementById('add-room-button');
      const addButtonText = document.getElementById('add-room-button-text');
      const addLoading = document.getElementById('add-room-loading');

      addButton.disabled = true;
      addButtonText.classList.add('hidden');
      addLoading.classList.remove('hidden');

      const success = await createRoom(roomName);

      addButton.disabled = false;
      addButtonText.classList.remove('hidden');
      addLoading.classList.add('hidden');

      if (success) {
        showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô "${roomName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        document.getElementById('add-room-form').reset();
        renderRoomsList();
      }
    });

    document.getElementById('list-room-filter').addEventListener('change', (e) => {
      selectedListRoomFilter = e.target.value;
      renderFacesList();
      updateFaceCount();
    });
    
    // GAS URL Configuration
    document.getElementById('save-url-btn').addEventListener('click', () => {
      const url = document.getElementById('gas-url-input').value.trim();
      if (url && url.endsWith('/exec')) {
        GAS_URL = url;
        localStorage.setItem('gas_url', url);
        document.getElementById('config-modal').style.display = 'none';
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'success');
        initApp();
      } else {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec)', 'error');
      }
    });

    document.getElementById('change-url-btn').addEventListener('click', () => {
        document.getElementById('gas-url-input').value = GAS_URL;
        document.getElementById('config-modal').style.display = 'flex';
        stopAttendanceCamera();
        stopRegisterCamera();
    });

    // Theme Customization & Init
    function onConfigChange(config) {
      // Apply primary button styles
      const primaryColor = config.primary_button_color || defaultConfig.primary_button_color;
      const secondaryColor = config.secondary_button_color || defaultConfig.secondary_button_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const cardColor = config.card_color || defaultConfig.card_color;

      document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
      document.body.style.fontFamily = config.font_family || defaultConfig.font_family;
      document.body.style.fontSize = `${config.font_size || defaultConfig.font_size}px`;

      document.querySelectorAll('.rounded-lg.shadow-lg').forEach(el => {
        if (!el.id.includes('attendance-summary')) {
            el.style.backgroundColor = cardColor;
            el.style.color = textColor;
        }
      });
      
      // Update all buttons with primary color
      document.querySelectorAll('button:not(.delete-btn):not(.delete-room-btn):not(#save-url-btn):not(#change-url-btn):not(#confirm-delete-cancel):not(#confirm-delete-confirm):not(#export-excel-btn):not(#delete-attendance-btn)').forEach(btn => {
        if (currentMainTab === 'attendance' && btn.id.includes('attendance') || 
            currentMainTab === 'register' && btn.id.includes('register') || 
            currentMainTab === 'rooms' && btn.id.includes('room') || 
            currentMainTab === 'report' && btn.id.includes('report')) {
            // Do nothing if it's the active tab button, let switchMainTab handle it
        } else {
            btn.style.backgroundColor = primaryColor;
            btn.style.color = 'white';
        }
      });
      
      // Buttons that need explicit secondary color
      const deleteBtns = document.querySelectorAll('.delete-btn, .delete-room-btn, #delete-attendance-btn');
      deleteBtns.forEach(btn => {
        btn.style.backgroundColor = secondaryColor;
        btn.style.color = 'white';
      });

      // Special button colors
      document.getElementById('save-url-btn').style.backgroundColor = primaryColor;
      document.getElementById('change-url-btn').style.backgroundColor = '#6b7280'; 
      document.getElementById('export-excel-btn').style.backgroundColor = '#10b981';
      document.getElementById('confirm-delete-confirm').style.backgroundColor = secondaryColor;
      
      // Re-apply tab styles
      switchMainTab(currentMainTab);
      switchRegisterTab(currentRegisterTab);

      // Re-render lists
      renderFacesList();
      renderRoomsList();
      updateDetectedList();
    }
    
    async function initApp() {
        if (!GAS_URL || !GAS_URL.endsWith('/exec')) {
            document.getElementById('config-modal').style.display = 'flex';
            document.getElementById('loading-overlay').style.display = 'none';
            return;
        }

        // 1. Load Face-API Models
        const modelsSuccess = await loadModels();
        if (!modelsSuccess) {
            return;
        }

        // 2. Load Data from GAS
        const roomSuccess = await fetchRooms();
        if (roomSuccess) {
            await fetchFaces();
        }
        
        // 3. Apply Theme/Config and Setup UI
        if (window.elementSdk) {
            window.elementSdk.applyInitialConfig(defaultConfig, onConfigChange);
        } else {
            onConfigChange(defaultConfig);
        }
        
        // 4. Restore last tab
        const lastTab = localStorage.getItem('currentMainTab') || 'attendance';
        switchMainTab(lastTab);
    }


    if (typeof faceapi !== 'undefined') {
      initApp();
    } else {
      window.addEventListener('load', initApp);
    }
  </script>
<div class="p-4 sm:p-6 bg-gray-50/50 border-t border-gray-200/50 text-center text-xs sm:text-sm text-gray-600 rounded-b-2xl">
<a href="https://sites.google.com/cmi.nfe.go.th/nfesantisuk" target="_blank">
<i class="fas fa-chalkboard-teacher text-indigo-600"></i> 
          ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ : ‡∏Ñ‡∏£‡∏π‡∏¢‡∏∏‡∏£‡∏ô‡∏±‡∏ô‡∏ó‡πå ‡∏Ç‡∏±‡∏ô‡πÅ‡∏Ç‡πà‡∏á‡∏ö‡∏∏‡∏ç ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç
        </a>
</div>
</body>
</html>